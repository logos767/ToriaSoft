{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4 max-w-7xl">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-box-open mr-2"></i>{{ title }}</h1>
        <a href="{{ url_for('main.reservation_list') }}" class="text-blue-500 hover:underline"><i class="fas fa-arrow-left mr-1"></i> Volver a Apartados</a>
    </div>

    <!-- Client Info & Reservation Summary -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Client & Order Info -->
        <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Información del Apartado</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-600">
                <p><strong>Cliente:</strong> <a href="{{ url_for('main.client_detail', client_id=order.client.id) }}" class="text-blue-600 hover:underline">{{ order.client.name }}</a></p>
                <p><strong>Cédula/RIF:</strong> {{ order.client.cedula_rif or 'N/A' }}</p>
                <p><strong>Fecha Apartado:</strong> {{ order.date_created|ve_datetime(fmt='%d/%m/%Y %H:%M') }}</p>
                <p><strong>Estado:</strong>
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                        {% if order.status == 'Apartado' %}bg-yellow-100 text-yellow-800
                        {% elif order.status == 'Pagado' %}bg-green-100 text-green-800
                        {% elif order.status == 'Entregado' %}bg-blue-100 text-blue-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ 'Pendiente' if order.status == 'Apartado' else order.status }}
                    </span>
                </p>
            </div>
        </div>

        <!-- Financial Summary -->
        <div class="bg-white p-6 rounded-lg shadow-md flex flex-col justify-center items-center text-center">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Resumen Financiero</h2>
            <p class="text-sm text-gray-500">Total del Apartado</p>
            <p class="text-2xl font-bold text-blue-700">{{ currency_symbol }}{{ "%.2f"|format(order.total_amount_usd) }}</p>
            <p class="text-sm text-gray-500 mt-2">Saldo Pendiente</p>
            {% if order.due_amount > 0.01 %}
                <p class="text-4xl font-bold text-red-600">{{ currency_symbol }}{{ "%.2f"|format(order.due_amount_usd) }}</p>
            {% else %}
                <p class="text-4xl font-bold text-green-600">{{ currency_symbol }}0.00</p>
                <p class="text-lg text-gray-500 mt-2">¡Totalmente Pagado!</p>
            {% endif %}
        </div>
    </div>

    <!-- Actions -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Acciones</h2>
        <div class="flex items-center space-x-4">
            {% if order.due_amount > 0.01 %}
            <button type="button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg add-payment-button"
                    data-order-id="{{ order.id }}"
                    data-due-amount="{{ order.due_amount }}"
                    title="Registrar Abono">
                <i class="fas fa-hand-holding-usd mr-2"></i>Registrar Abono
            </button>
            {% endif %}

            {% if order.status == 'Entregado' %}
            <span class="px-4 py-2 rounded-lg bg-gray-200 text-gray-600 font-bold">
                <i class="fas fa-check-circle mr-2 text-green-500"></i>Entregado
            </span>
            {% elif order.due_amount <= 0.01 %}
            <form method="POST" action="{{ url_for('main.reservation_detail', order_id=order.id) }}" onsubmit="return confirm('¿Está seguro que desea marcar este apartado como entregado? Esta acción no se puede deshacer.');">
                <input type="hidden" name="action" value="deliver">
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                    <i class="fas fa-check-circle mr-2"></i>Marcar como Entregado
                </button>
            </form>
            {% else %}
            <p class="text-gray-500">El apartado debe estar totalmente pagado para poder marcarlo como entregado.</p>
            {% endif %}
             <a href="{{ url_for('main.print_reservation_receipt', order_id=order.id) }}" target="_blank" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                <i class="fas fa-print mr-2"></i>Imprimir Recibo
            </a>
        </div>
    </div>

    <!-- Order Items -->
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Productos Apartados</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Códigos</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unit. ({{ currency_symbol }})</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal ({{ currency_symbol }})</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for item in order.items %}
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                            <div><strong>COD:</strong> {{ item.product.codigo_producto or 'N/A' }}</div>
                            <div> <i class="fas fa-barcode w-4 inline-block text-left"></i> {{ item.product.barcode }}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ item.product.name }}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-500">{{ item.quantity }}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-right text-gray-800">{{ "%.2f"|format(item.price / order.exchange_rate_at_sale) }}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-right text-gray-800">{{ "%.2f"|format((item.price * item.quantity) / order.exchange_rate_at_sale) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <a href="{{ url_for('main.order_detail', order_id=order.id) }}" class="text-blue-500 hover:underline">
           <i class="fas fa-arrow-right mr-1"></i>Ir a detalles de la orden
        </a>
    </div>

    <!-- Payment History -->
    <div class="bg-white p-6 rounded-lg shadow-md mt-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Historial de Abonos</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Método</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalles</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for payment in order.payments %}
                    <tr>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">{{ payment.date|ve_datetime(fmt='%d/%m/%Y %H:%M') }}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-800 flex items-center">
                            {% set icon_found = namespace(path=None, name=None) %}
                            {% for bank_name, icon_file in BANK_ICONS.items() %}
                                {% if bank_name.lower() in payment.method.replace('_', ' ').lower() %}
                                    {% set icon_found.path = url_for('static', filename='img/bancos/' + icon_file) %}
                                    {% set icon_found.name = bank_name %}
                                {% endif %}
                            {% endfor %}

                            {% if icon_found.path %}
                                <img src="{{ icon_found.path }}" alt="{{ icon_found.name }}" class="inline-block h-6 w-6 mr-2" title="{{ icon_found.name }}">
                            {% endif %}
                            {{ payment.method.replace('_', ' ')|title }}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if payment.reference %}Ref: {{ payment.reference }}{% endif %}
                            {% if payment.issuing_bank %} Bco: {{ payment.issuing_bank }}{% endif %}
                            {% if payment.sender_id %} CI/Tlf: {{ payment.sender_id }}{% endif %}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-right font-semibold text-gray-900">
                            <div>Bs. {{ "%.2f"|format(payment.amount_ves_equivalent) }}</div>
                            {% if payment.amount_usd_equivalent > 0 %}
                            <div class="text-xs text-gray-500 font-normal">{{ currency_symbol }} {{ "%.2f"|format(payment.amount_usd_equivalent) }}</div>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="px-6 py-10 text-center text-gray-500">No se han registrado abonos para este apartado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
</div>

<!-- Hidden form for submitting payments -->
<form id="payment-submission-form" method="POST" action="{{ url_for('main.reservation_detail', order_id=order.id) }}" class="hidden">
    <input type="hidden" name="payments_data" id="payment-form-data-input">
</form>

<!-- Include the generic payment modal -->
{% include 'shared/payment_modal.html' %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Generic Payment Modal Logic ---
    const paymentModal = document.getElementById('payment-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const finalizeOrderBtn = document.getElementById('finalize-order-btn');
    const addPaymentBtnModal = document.getElementById('add-payment-btn-modal');

    const modalTotalAmount = document.getElementById('modal-total-amount');
    const modalPaidAmount = document.getElementById('modal-paid-amount');
    const modalRemainingAmount = document.getElementById('modal-remaining-amount');
    const modalTotalAmountUsd = document.getElementById('modal-total-amount-usd');
    const modalPaidAmountUsd = document.getElementById('modal-paid-amount-usd');
    const modalRemainingAmountUsd = document.getElementById('modal-remaining-amount-usd');
    
    const paymentMethodSelect = document.getElementById('payment-method');
    const paymentDateInput = document.getElementById('payment-date');
    const paymentIssuingBankGroup = document.getElementById('payment-issuing-bank-group');
    const paymentSenderIdGroup = document.getElementById('payment-sender-id-group');
    const paymentAmountInput = document.getElementById('payment-amount');
    const paymentReferenceGroup = document.getElementById('payment-reference-group');
    const paymentBankGroup = document.getElementById('payment-bank-group');
    const paymentPosGroup = document.getElementById('payment-pos-group');
    const paymentCashboxGroup = document.getElementById('payment-cashbox-group');
    const paymentCurrencyGroup = document.getElementById('payment-currency-group');
    const paymentCurrencySelect = document.getElementById('payment-currency');
    const paymentBankSelect = document.getElementById('payment-bank');
    
    const paymentsListDiv = document.getElementById('payments-list');
    const paymentSubmissionForm = document.getElementById('payment-submission-form');
    const paymentFormDataInput = document.getElementById('payment-form-data-input');
    const currencySymbol = '{{ currency_symbol }}';

    let payments = [];
    let orderTotal = 0;
    let currentRate = parseFloat("{{ current_rate }}");
    let previousTransferCurrency;
    let previousPaymentMethod;

    function openPaymentModalForAbono(orderId, dueAmount) {
        orderTotal = parseFloat(dueAmount);
        payments = []; // Reset payments for each new modal opening
        
        document.getElementById('payment-modal-title').textContent = `Registrar Abono para Apartado #${String(orderId).padStart(9, '0')}`;
        document.getElementById('credit-sale-notice').classList.add('hidden');
        finalizeOrderBtn.textContent = 'Registrar Abono';

        // Initialize previous values here, when the modal is open and elements exist
        previousPaymentMethod = paymentMethodSelect.value;
        previousTransferCurrency = paymentCurrencySelect.value;

        // Set current date for the payment
        if (paymentDateInput) {
            paymentDateInput.value = new Date().toISOString().slice(0, 16);
        }

        modalTotalAmount.textContent = orderTotal.toFixed(2) + ' Bs';
        if (currentRate > 0) {
           modalTotalAmountUsd.textContent = (orderTotal / currentRate).toFixed(2) + ' ' + currencySymbol;
        }
        updatePaymentSummary();
        paymentModal.classList.remove('hidden');
    }

    function closePaymentModal() {
        payments = [];
        paymentsListDiv.innerHTML = '';
        paymentModal.classList.add('hidden');
    }

    function updatePaymentSummary() {
        const totalPaid = payments.reduce((sum, p) => sum + p.amount_ves_equivalent, 0);
        const remaining = orderTotal - totalPaid;

        modalPaidAmount.textContent = totalPaid.toFixed(2) + ' Bs';
        modalPaidAmountUsd.textContent = (totalPaid / currentRate).toFixed(2) + ' ' + currencySymbol;

        modalRemainingAmount.textContent = Math.max(0, remaining).toFixed(2) + ' Bs';
        if (currentRate > 0) {
            modalRemainingAmountUsd.textContent = (Math.max(0, remaining) / currentRate).toFixed(2) + ' ' + currencySymbol;
        }

        finalizeOrderBtn.disabled = totalPaid <= 0;
        
        const method = paymentMethodSelect.value;
        if (method === 'efectivo_usd' && currentRate > 0) {
            paymentAmountInput.value = (remaining / currentRate).toFixed(2);
        } else {
            paymentAmountInput.value = remaining.toFixed(2);
        }
    }

    function addPayment() {
        const paymentMethodSelect = document.getElementById('payment-method');
        const paymentCurrencySelect = document.getElementById('payment-currency');
        const paymentAmountInput = document.getElementById('payment-amount');
        const paymentDateInput = document.getElementById('payment-date');
        const addPaymentBtnModal = document.getElementById('add-payment-btn-modal');

        if (!paymentMethodSelect || !paymentCurrencySelect || !paymentAmountInput || !paymentDateInput) {
            return;
        }

        payments = []; // This modal only allows one payment at a time for simplicity
        const method = paymentMethodSelect.value;
        const transfer_currency = paymentCurrencySelect.value;
        const amount = parseFloat(paymentAmountInput.value);
        if (!amount || amount <= 0) { alert("Por favor, ingrese un monto válido."); return; }

        const paymentDate = paymentDateInput ? paymentDateInput.value : new Date().toISOString();
        const issuingBank = document.getElementById('payment-issuing-bank').value;
        const senderId = document.getElementById('payment-sender-id').value;

        let amount_ves_equivalent = amount;
        let currency_paid = 'VES';
        if (method === 'efectivo_usd' || (method === 'transferencia' && transfer_currency === 'USD')) {
            amount_ves_equivalent = amount * currentRate;
            currency_paid = 'USD';
        }

        const payment = {
            method: method, amount_paid: amount, currency_paid: currency_paid,
            amount_ves_equivalent: amount_ves_equivalent, reference: document.getElementById('payment-reference').value,
            date: paymentDate,
            issuing_bank: issuingBank,
            sender_id: senderId,
            bank_id: document.getElementById('payment-bank').value ? parseInt(document.getElementById('payment-bank').value) : null,
            pos_id: document.getElementById('payment-pos').value ? parseInt(document.getElementById('payment-pos').value) : null,
            cash_box_id: document.getElementById('payment-cashbox').value ? parseInt(document.getElementById('payment-cashbox').value) : null,
        };
        payments.push(payment);
        updatePaymentSummary();
        if (addPaymentBtnModal) {
            addPaymentBtnModal.textContent = 'Actualizar Datos del Abono';
        }
    }

    // --- Event Listeners ---
    document.querySelectorAll('.add-payment-button').forEach(button => {
        button.addEventListener('click', function() {
            const orderId = this.dataset.orderId;
            const dueAmount = this.dataset.dueAmount;
            openPaymentModalForAbono(orderId, dueAmount);
        });
    });

    closeModalBtn.addEventListener('click', closePaymentModal);
    addPaymentBtnModal.addEventListener('click', addPayment);

    paymentMethodSelect.addEventListener('change', function() {
        const method = this.value;
        const amount = parseFloat(paymentAmountInput.value);
        
        function filterBankOptions() {
            const selectedCurrency = paymentCurrencySelect.value;
            const bankOptions = paymentBankSelect.options;
            for (let i = 1; i < bankOptions.length; i++) { // Skip "Seleccione un banco"
                const option = bankOptions[i];
                if (option.dataset.currency === selectedCurrency) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            }
            if (paymentBankSelect.selectedOptions.length > 0 && paymentBankSelect.selectedOptions[0].style.display === 'none') {
                paymentBankSelect.value = '';
            }
        }

        const isTransfer = method === 'transferencia';
        [paymentReferenceGroup, paymentIssuingBankGroup, paymentSenderIdGroup, paymentBankGroup, paymentCurrencyGroup].forEach(el => el.classList.toggle('hidden', !isTransfer));
        paymentPosGroup.classList.toggle('hidden', method !== 'punto_de_venta');
        paymentCashboxGroup.classList.toggle('hidden', !method.startsWith('efectivo'));

        if (isTransfer) {
            document.getElementById('payment-sender-id').value = '{{ order.client.phone or '' }}';
            filterBankOptions();
        } else {
            paymentBankSelect.value = '';
        }

        const newTransferCurrency = paymentCurrencySelect.value;

        if (amount && amount > 0 && currentRate > 0) {
            const wasUsd = previousPaymentMethod === 'efectivo_usd' || (previousPaymentMethod === 'transferencia' && previousTransferCurrency === 'USD');
            const isUsd = method === 'efectivo_usd' || (isTransfer && newTransferCurrency === 'USD');

            if (wasUsd && !isUsd) { // USD -> VES
                paymentAmountInput.value = (amount * currentRate).toFixed(2);
            } else if (!wasUsd && isUsd) { // VES -> USD
                paymentAmountInput.value = (amount / currentRate).toFixed(2);
            }
        } else {
            updatePaymentSummary();
        }
        
        previousPaymentMethod = method;
        previousTransferCurrency = newTransferCurrency;
    });

    paymentCurrencySelect.addEventListener('change', function() {
        paymentMethodSelect.dispatchEvent(new Event('change'));
    });

    finalizeOrderBtn.addEventListener('click', function() {
        if (payments.length === 0) {
            addPayment(); // Try to add payment from form fields
        }
        if (payments.length === 0) { alert("Debe agregar al menos un método de pago para registrar el abono."); return; }
        paymentFormDataInput.value = JSON.stringify(payments);
        paymentSubmissionForm.submit();
    });

    paymentMethodSelect.dispatchEvent(new Event('change'));
});
</script>
{% endblock %}