{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4 max-w-7xl">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-box-open mr-2"></i>{{ title }}</h1>
        <a href="{{ url_for('main.reservation_list') }}" class="text-blue-500 hover:underline"><i class="fas fa-arrow-left mr-1"></i> Volver a Apartados</a>
    </div>

    <!-- Client Info & Reservation Summary -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Client & Order Info -->
        <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Información del Apartado</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-600">
                <p><strong>Cliente:</strong> <a href="{{ url_for('main.client_detail', client_id=order.client.id) }}" class="text-blue-600 hover:underline">{{ order.client.name }}</a></p>
                <p><strong>Cédula/RIF:</strong> {{ order.client.cedula_rif or 'N/A' }}</p>
                <p><strong>Fecha Apartado:</strong> {{ order.date_created|ve_datetime(fmt='%d/%m/%Y %H:%M') }}</p>
                <p><strong>Estado:</strong> 
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {% if order.status == 'Apartado' %}bg-yellow-100 text-yellow-800{% elif order.status == 'Pagada' %}bg-green-100 text-green-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                        {{ order.status }}
                    </span>
                </p>
            </div>
        </div>

        <!-- Financial Summary -->
        <div class="bg-white p-6 rounded-lg shadow-md flex flex-col justify-center items-center text-center">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Resumen Financiero</h2>
            <p class="text-sm text-gray-500">Total del Apartado</p>
            <p class="text-2xl font-bold text-blue-700">{{ currency_symbol }}{{ "%.2f"|format(order.total_amount / current_rate) }}</p>
            <p class="text-sm text-gray-500 mt-2">Saldo Pendiente</p>
            {% if order.due_amount > 0.01 %}
                <p class="text-4xl font-bold text-red-600">{{ currency_symbol }}{{ "%.2f"|format(order.due_amount / current_rate) }}</p>
            {% else %}
                <p class="text-4xl font-bold text-green-600">{{ currency_symbol }}0.00</p>
                <p class="text-lg text-gray-500 mt-2">¡Totalmente Pagado!</p>
            {% endif %}
        </div>
    </div>

    <!-- Actions -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Acciones</h2>
        <div class="flex items-center space-x-4">
            {% if order.due_amount > 0.01 %}
            <button type="button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg add-payment-button"
                    data-order-id="{{ order.id }}" 
                    data-due-amount="{{ order.due_amount }}"
                    title="Registrar Abono">
                <i class="fas fa-hand-holding-usd mr-2"></i>Registrar Abono
            </button>
            {% endif %}

            {% if order.due_amount <= 0.01 %}
            <form method="POST" action="{{ url_for('main.reservation_detail', order_id=order.id) }}" onsubmit="return confirm('¿Está seguro que desea marcar este apartado como entregado? Esta acción no se puede deshacer.');">
                <input type="hidden" name="action" value="deliver">
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                    <i class="fas fa-check-circle mr-2"></i>Marcar como Entregado
                </button>
            </form>
            {% else %}
            <p class="text-gray-500">El apartado debe estar totalmente pagado para poder marcarlo como entregado.</p>
            {% endif %}
             <a href="{{ url_for('main.print_reservation_receipt', order_id=order.id) }}" target="_blank" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                <i class="fas fa-print mr-2"></i>Imprimir Recibo
            </a>
        </div>
    </div>

    <!-- Order Items -->
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Productos Apartados</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unit. ({{ currency_symbol }})</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal ({{ currency_symbol }})</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for item in order.items %}
                    <tr>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ item.product.name }}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-500">{{ item.quantity }}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-right text-gray-800">{{ "%.2f"|format(item.price / current_rate) }}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-right text-gray-800">{{ "%.2f"|format((item.price * item.quantity) / current_rate) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Hidden form for submitting payments -->
<form id="payment-submission-form" method="POST" action="{{ url_for('main.reservation_detail', order_id=order.id) }}" class="hidden">
    <input type="hidden" name="payments_data" id="payment-form-data-input">
</form>

<!-- Include the generic payment modal -->
{% include 'shared/payment_modal.html' %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Generic Payment Modal Logic ---
    const paymentModal = document.getElementById('payment-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const finalizeOrderBtn = document.getElementById('finalize-order-btn');
    const addPaymentBtnModal = document.getElementById('add-payment-btn-modal');

    const modalTotalAmount = document.getElementById('modal-total-amount');
    const modalPaidAmount = document.getElementById('modal-paid-amount');
    const modalRemainingAmount = document.getElementById('modal-remaining-amount');
    
    const paymentMethodSelect = document.getElementById('payment-method');
    const paymentAmountInput = document.getElementById('payment-amount');
    const paymentReferenceGroup = document.getElementById('payment-reference-group');
    const paymentBankGroup = document.getElementById('payment-bank-group');
    const paymentPosGroup = document.getElementById('payment-pos-group');
    const paymentCashboxGroup = document.getElementById('payment-cashbox-group');

    const paymentsListDiv = document.getElementById('payments-list');
    const paymentSubmissionForm = document.getElementById('payment-submission-form');
    const paymentFormDataInput = document.getElementById('payment-form-data-input');

    let payments = [];
    let orderTotal = 0;
    let currentRate = {{ current_rate }};

    function openPaymentModalForAbono(orderId, dueAmount) {
        orderTotal = parseFloat(dueAmount);
        payments = []; // Reset payments for each new modal opening
        
        document.getElementById('payment-modal-title').textContent = `Registrar Abono para Apartado #${String(orderId).padStart(9, '0')}`;
        document.getElementById('credit-sale-notice').classList.add('hidden');
        finalizeOrderBtn.textContent = 'Registrar Abono';

        modalTotalAmount.textContent = orderTotal.toFixed(2) + ' Bs';
        updatePaymentSummary();
        paymentModal.classList.remove('hidden');
    }

    function closePaymentModal() {
        paymentModal.classList.add('hidden');
    }

    function updatePaymentSummary() {
        const totalPaid = payments.reduce((sum, p) => sum + p.amount_ves_equivalent, 0);
        const remaining = orderTotal - totalPaid;

        modalPaidAmount.textContent = totalPaid.toFixed(2) + ' Bs';
        modalRemainingAmount.textContent = Math.max(0, remaining).toFixed(2) + ' Bs';

        finalizeOrderBtn.disabled = totalPaid <= 0;
        
        const method = paymentMethodSelect.value;
        if (method === 'efectivo_usd' && currentRate > 0) {
            paymentAmountInput.value = (remaining / currentRate).toFixed(2);
        } else {
            paymentAmountInput.value = remaining.toFixed(2);
        }
    }

    function addPayment() {
        payments = []; // This modal only allows one payment at a time for simplicity
        const method = paymentMethodSelect.value;
        const amount = parseFloat(paymentAmountInput.value);
        if (!amount || amount <= 0) { alert("Por favor, ingrese un monto válido."); return; }

        let amount_ves_equivalent = amount;
        let currency_paid = 'VES';
        if (method === 'efectivo_usd') {
            amount_ves_equivalent = amount * currentRate;
            currency_paid = 'USD';
        }

        const payment = {
            method: method, amount_paid: amount, currency_paid: currency_paid,
            amount_ves_equivalent: amount_ves_equivalent, reference: document.getElementById('payment-reference').value,
            bank_id: document.getElementById('payment-bank').value ? parseInt(document.getElementById('payment-bank').value) : null,
            pos_id: document.getElementById('payment-pos').value ? parseInt(document.getElementById('payment-pos').value) : null,
            cash_box_id: document.getElementById('payment-cashbox').value ? parseInt(document.getElementById('payment-cashbox').value) : null,
        };
        payments.push(payment);
        updatePaymentSummary();
    }

    // --- Event Listeners ---
    document.querySelectorAll('.add-payment-button').forEach(button => {
        button.addEventListener('click', function() {
            const orderId = this.dataset.orderId;
            const dueAmount = this.dataset.dueAmount;
            openPaymentModalForAbono(orderId, dueAmount);
        });
    });

    closeModalBtn.addEventListener('click', closePaymentModal);
    addPaymentBtnModal.addEventListener('click', addPayment);

    paymentMethodSelect.addEventListener('change', function() {
        const method = this.value;
        paymentReferenceGroup.classList.toggle('hidden', method !== 'transferencia');
        paymentBankGroup.classList.toggle('hidden', method !== 'transferencia');
        paymentPosGroup.classList.toggle('hidden', method !== 'punto_de_venta');
        paymentCashboxGroup.classList.toggle('hidden', !method.startsWith('efectivo'));
        updatePaymentSummary();
    });

    finalizeOrderBtn.addEventListener('click', function() {
        if (payments.length === 0) { alert("Debe agregar al menos un método de pago para registrar el abono."); return; }
        paymentFormDataInput.value = JSON.stringify(payments);
        paymentSubmissionForm.submit();
    });

    paymentMethodSelect.dispatchEvent(new Event('change'));
});
</script>
{% endblock %}
