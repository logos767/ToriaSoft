{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4 max-w-4xl">
    <div class="bg-white p-6 rounded-lg shadow-md">
        <form method="POST" action="{{ url_for('main.new_debit_note') }}">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h1 class="text-2xl font-bold text-gray-800"><i class="fas fa-minus-circle mr-2 text-red-500"></i>{{ title }}</h1>
                <a href="{{ url_for('main.client_list') }}" class="text-blue-500 hover:underline"><i class="fas fa-arrow-left mr-1"></i> Volver a Clientes</a>
            </div>

            <!-- Client Selection -->
            <div class="mb-4">
                <label for="client_search" class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                <div class="relative">
                    <input type="text" id="client_search" name="client_search" autocomplete="off" placeholder="Buscar por Cédula, RIF o Nombre..." class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="hidden" id="client_id" name="client_id" required>
                    <div id="client_suggestions" class="border border-gray-300 rounded mt-1 max-h-40 overflow-y-auto bg-white hidden z-10 absolute w-full"></div>
                    <div id="client_info" class="mt-2 p-3 border border-gray-200 rounded bg-gray-50 hidden text-sm">
                        <div class="font-semibold mb-1">Cliente Seleccionado:</div>
                        <div><strong>Nombre:</strong> <span id="client_name"></span></div>
                        <div><strong>Cédula/RIF:</strong> <span id="client_cedula_rif"></span></div>
                    </div>
                </div>
            </div>

            <!-- Debit Note Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                 <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700">Monto de la Deuda (USD)</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm">$</span>
                        </div>
                        <input type="number" name="amount" id="amount" class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-7 pr-12 sm:text-sm border-gray-300 rounded-md" placeholder="0.00" step="0.01" min="0.01" required>
                    </div>
                </div>
                <div>
                    <label for="start_date" class="block text-sm font-medium text-gray-700">Fecha de Inicio de la Deuda</label>
                    <input type="date" id="start_date" name="start_date" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                </div>
            </div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="due_date" class="block text-sm font-medium text-gray-700">Fecha de Vencimiento (Opcional)</label>
                    <input type="date" id="due_date" name="due_date" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <p class="mt-1 text-xs text-gray-500">Si se deja en blanco, se asumirán 30 días de plazo.</p>
                </div>
            </div>
            <div class="mb-6">
                <label for="concept" class="block text-sm font-medium text-gray-700">Concepto</label>
                <textarea id="concept" name="concept" rows="3" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required placeholder="Ej: Deuda por servicio de instalación, ajuste de cuenta, etc."></textarea>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-end mt-6">
                <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg focus:outline-none focus:shadow-outline transition-all">
                    <i class="fas fa-save mr-2"></i>Guardar Nota de Débito
                </button>
            </div>
        </form>
    </div>
</div>

<!-- New Client Modal -->
<div id="new-client-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl leading-6 font-medium text-gray-900">Crear Nuevo Cliente</h3>
                <button id="close-new-client-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="new-client-modal-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden" role="alert">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline" id="new-client-modal-error-message"></span>
            </div>
            <form id="new-client-form">
                <div class="space-y-4">
                    <div>
                        <label for="new-client-name" class="block text-sm font-medium text-gray-700">Nombre Completo o Razón Social</label>
                        <input type="text" id="new-client-name" name="name" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new-client-cedula-rif" class="block text-sm font-medium text-gray-700">Cédula o RIF</label>
                        <input type="text" id="new-client-cedula-rif" name="cedula_rif" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new-client-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="new-client-email" name="email" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new-client-phone" class="block text-sm font-medium text-gray-700">Teléfono</label>
                        <input type="tel" id="new-client-phone" name="phone" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new-client-address" class="block text-sm font-medium text-gray-700">Dirección</label>
                        <textarea id="new-client-address" name="address" rows="2" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                    </div>
                </div>
                <div class="mt-8 flex justify-end">
                    <button type="button" id="cancel-new-client-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 mr-4">Cancelar</button>
                    <button type="button" id="save-new-client-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i>Guardar Cliente</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const startDateInput = document.getElementById('start_date');
    if (startDateInput) {
        startDateInput.valueAsDate = new Date();
    }

    // --- Client Search and Creation Logic ---
    const clientSearchInput = document.getElementById('client_search');
    const clientSuggestions = document.getElementById('client_suggestions');
    const clientIdInput = document.getElementById('client_id');
    const clientInfoDiv = document.getElementById('client_info');
    const clientNameSpan = document.getElementById('client_name');
    const clientCedulaRifSpan = document.getElementById('client_cedula_rif');
    
    const newClientModal = document.getElementById('new-client-modal');
    const closeNewClientModalBtn = document.getElementById('close-new-client-modal-btn');
    const cancelNewClientBtn = document.getElementById('cancel-new-client-btn');
    const saveNewClientBtn = document.getElementById('save-new-client-btn');
    const newClientForm = document.getElementById('new-client-form');
    const newClientModalError = document.getElementById('new-client-modal-error');
    const newClientModalErrorMessage = document.getElementById('new-client-modal-error-message');

    let debounceTimeout = null;
    let selectedClient = null;

    function clearClientInfo() {
        clientNameSpan.textContent = '';
        clientCedulaRifSpan.textContent = '';
        clientInfoDiv.classList.add('hidden');
        clientIdInput.value = '';
        selectedClient = null;
    }

    function showClientInfo(client) {
        clientNameSpan.textContent = client.name || '';
        clientCedulaRifSpan.textContent = client.cedula_rif || 'N/A';
        clientInfoDiv.classList.remove('hidden');
        clientIdInput.value = client.id;
        selectedClient = client;
        clientSearchInput.value = `${client.name} (${client.cedula_rif || 'N/A'})`;
        clientSuggestions.classList.add('hidden');
    }

    function fetchClientSuggestions(query) {
        fetch(`/api/search_clients?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                clientSuggestions.innerHTML = '';
                if (data.clients.length > 0) {
                    data.clients.forEach(client => {
                        const div = document.createElement('div');
                        div.textContent = `${client.name} - ${client.cedula_rif || 'Sin Cédula/RIF'}`;
                        div.classList.add('cursor-pointer', 'px-3', 'py-2', 'hover:bg-blue-100');
                        div.addEventListener('click', () => showClientInfo(client));
                        clientSuggestions.appendChild(div);
                    });
                }
                const createDiv = document.createElement('div');
                createDiv.innerHTML = `<i class="fas fa-plus-circle mr-2"></i>Crear nuevo cliente: "${query}"`;
                createDiv.classList.add('cursor-pointer', 'px-3', 'py-2', 'hover:bg-green-100', 'font-semibold', 'text-green-700', 'border-t');
                createDiv.addEventListener('click', openNewClientModal);
                clientSuggestions.appendChild(createDiv);
                clientSuggestions.classList.remove('hidden');
            });
    }

    clientSearchInput.addEventListener('input', () => {
        const query = clientSearchInput.value.trim();
        clearClientInfo();
        if (debounceTimeout) clearTimeout(debounceTimeout);
        if (query.length < 2) {
            clientSuggestions.classList.add('hidden');
            return;
        }
        debounceTimeout = setTimeout(() => fetchClientSuggestions(query), 300);
    });

    document.addEventListener('click', function(e) {
        if (!clientSearchInput.contains(e.target) && !clientSuggestions.contains(e.target)) {
            clientSuggestions.classList.add('hidden');
        }
    });

    function openNewClientModal() {
        const searchText = clientSearchInput.value.trim();
        newClientForm.reset();
        newClientModalError.classList.add('hidden');
        if (!isNaN(searchText) && !isNaN(parseFloat(searchText))) {
            document.getElementById('new-client-cedula-rif').value = searchText;
        } else {
            document.getElementById('new-client-name').value = searchText;
        }
        newClientModal.classList.remove('hidden');
        document.getElementById('new-client-name').focus();
    }

    function closeNewClientModal() {
        newClientModal.classList.add('hidden');
    }

    closeNewClientModalBtn.addEventListener('click', closeNewClientModal);
    cancelNewClientBtn.addEventListener('click', closeNewClientModal);

    saveNewClientBtn.addEventListener('click', () => {
        const name = document.getElementById('new-client-name').value.trim();
        if (!name) {
            newClientModalErrorMessage.textContent = 'El nombre del cliente es obligatorio.';
            newClientModalError.classList.remove('hidden');
            return;
        }
        const clientData = {
            name: name,
            cedula_rif: document.getElementById('new-client-cedula-rif').value.trim(),
            email: document.getElementById('new-client-email').value.trim(),
            phone: document.getElementById('new-client-phone').value.trim(),
            address: document.getElementById('new-client-address').value.trim(),
        };
        fetch('/api/clientes/nuevo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(clientData)
        })
        .then(response => {
            if (!response.ok) { return response.json().then(err => { throw new Error(err.error || 'Error desconocido'); }); }
            return response.json();
        })
        .then(newClient => {
            closeNewClientModal();
            showClientInfo(newClient);
        })
        .catch(error => {
            newClientModalErrorMessage.textContent = error.message;
            newClientModalError.classList.remove('hidden');
        });
    });

    // Handle pre-selected client from URL param
    const urlParams = new URLSearchParams(window.location.search);
    const preselectedClientId = urlParams.get('client_id');
    if (preselectedClientId) {
        fetch(`/api/search_clients?q=${preselectedClientId}`)
            .then(response => response.json())
            .then(data => {
                const client = data.clients.find(c => c.id == preselectedClientId);
                if (client) {
                    showClientInfo(client);
                }
            });
    }
    // --- End Client Logic ---
});
</script>
{% endblock %}