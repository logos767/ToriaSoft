<!DOCTYPE html>
<html>
<head>
    <!-- ... tus otras etiquetas head ... -->
    <title>ToriaSoft</title>
    <!-- Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <!-- ... tu CSS ... -->
    <style>
        /* Solución para el panel de navegación que se corta */
        /* Esto asume que el panel de navegación es un elemento <aside> o tiene una clase .sidebar */
        /* Permite que el panel de navegación tenga su propia barra de desplazamiento cuando el contenido es demasiado largo. */
        aside, .sidebar {
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- ... tu contenido de la barra de navegación y página ... -->


    <!-- ... tus otros scripts ... -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <!-- Socket.IO Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <!-- Script para marcar notificaciones como leídas (el que ya tenías) -->
    <script>
    $(document).ready(function() {
        if ($('#notifications-dropdown').length) {
            $('#notifications-dropdown').on('click', function(e) {
                let badge = $(this).find('.navbar-badge');
                if (badge.length > 0 && parseInt(badge.text()) > 0) {
                    const url = "{{ url_for('main.mark_notifications_as_read') }}";
                    $.post(url)
                        .done(function(data) {
                            if (data.success) {
                                badge.fadeOut('slow', function() { $(this).remove(); });
                            }
                        });
                }
            });
        }
    });
    </script>

    <!-- NUEVO SCRIPT PARA NOTIFICACIONES EN TIEMPO REAL -->
    {% if current_user.is_authenticated and current_user.role == 'administrador' %}
    <script type="text/javascript">
        $(document).ready(function() {
            // Configuración de Toastr
            toastr.options = {
                "closeButton": true,
                "progressBar": true,
                "positionClass": "toast-top-right",
                "timeOut": "7000", // 7 segundos
            };

            var socket = io(); // Conectar al servidor WebSocket

            socket.on('connect', function() {
                console.log('Conectado al servidor de notificaciones.');
            });

            // Escuchar el evento 'new_notification'
            socket.on('new_notification', function(data) {
                // 1. Mostrar el pop-up con Toastr
                let toast = toastr.info(data.message, 'Nueva Notificación', {
                    "onclick": function() {
                        if (data.link) {
                            window.location.href = data.link;
                        }
                    }
                });

                // 2. Actualizar el contador de la campana
                let badge = $('#notifications-dropdown .navbar-badge');
                if (badge.length) {
                    badge.text(parseInt(badge.text()) + 1);
                } else {
                    // Si no hay contador, lo crea
                    $('#notifications-dropdown').append('<span class="badge badge-warning navbar-badge">1</span>');
                }

                // 3. (Opcional) Añadir la notificación a la lista desplegable dinámicamente
                const newNotificationHtml = `
                    <div class="dropdown-divider"></div>
                    <a href="${data.link || '#'}" class="dropdown-item">
                        <i class="fas fa-file mr-2"></i> ${data.message.substring(0, 40)}
                        <span class="float-right text-muted text-sm">${data.created_at}</span>
                    </a>`;
                $('.dropdown-menu .dropdown-header').after(newNotificationHtml);
            });
        });
    </script>
    {% endif %}

</body>
</html>
