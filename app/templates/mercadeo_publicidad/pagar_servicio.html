{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4 max-w-4xl">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-money-bill-wave mr-2"></i>{{ title }}</h1>
        <a href="{{ url_for('main.marketing_service_list') }}" class="text-blue-500 hover:underline"><i class="fas fa-arrow-left mr-1"></i> Volver al Historial</a>
    </div>

    <form id="payment-form" method="POST" class="bg-white p-8 rounded-lg shadow-lg space-y-6">
        <!-- Selección de Servicio -->
        <div>
            <label for="service_id" class="block text-sm font-medium text-gray-700 mb-1">Servicio a Pagar</label>
            <select id="service_id" name="service_id" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                <option value="">-- Seleccione un servicio pendiente --</option>
                {% for service in pending_services %}
                <option value="{{ service.id }}" data-value-usd="{{ service.service_value_usd }}" data-provider="{{ service.provider.name }}">
                    {{ service.service_code }} - {{ service.provider.name }} - {{ service.service_description[:50] }}... ({{ currency_symbol }}{{ "%.2f"|format(service.service_value_usd) }})
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Detalles del Servicio Seleccionado -->
        <div id="service-details" class="hidden bg-gray-50 p-4 rounded-md border border-gray-200">
            <h3 class="font-semibold text-lg text-gray-800">Detalles del Servicio</h3>
            <p class="text-gray-600"><strong>Proveedor:</strong> <span id="detail-provider"></span></p>
            <p class="text-gray-600"><strong>Monto a Pagar (USD):</strong> <span id="detail-amount-usd" class="font-bold"></span></p>
            <p class="text-gray-600"><strong>Monto a Pagar (VES):</strong> <span id="detail-amount-ves" class="font-bold"></span></p>
        </div>

        <!-- Método de Pago -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="payment_method" class="block text-sm font-medium text-gray-700 mb-1">Pagar desde</label>
                <select id="payment_method" name="payment_method" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option value="">-- Seleccione un método --</option>
                    <option value="bank">Banco (Transferencia)</option>
                    <option value="cash_ves">Caja (Efectivo VES)</option>
                    <option value="cash_usd">Caja (Efectivo USD)</option>
                </select>
            </div>
            <div>
                <label for="account_id" class="block text-sm font-medium text-gray-700 mb-1">Cuenta de Origen</label>
                <select id="account_id" name="account_id" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" disabled>
                    <option value="">-- Seleccione una cuenta --</option>
                </select>
            </div>
        </div>

        <!-- Fecha de Pago -->
        <div>
            <label for="payment-date" class="block text-sm font-medium text-gray-700">Fecha y Hora del Pago</label>
            <input type="datetime-local" id="payment-date" name="payment_date" required
                   class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
        </div>

        <!-- Botón de Envío -->
        <div class="pt-4 border-t border-gray-200">
            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                <i class="fas fa-check-circle mr-2"></i>Confirmar Pago
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const serviceSelect = document.getElementById('service_id');
    const serviceDetailsDiv = document.getElementById('service-details');
    const paymentMethodSelect = document.getElementById('payment_method');
    const accountSelect = document.getElementById('account_id');
    const paymentDateInput = document.getElementById('payment-date');

    const banks = {{ banks|tojson }};
    const cashBoxes = {{ cash_boxes|tojson }};
    const currentRate = parseFloat("{{ current_rate }}");

    // Pre-seleccionar servicio si viene en la URL
    const preselectedServiceId = "{{ preselected_service_id }}";
    if (preselectedServiceId) {
        serviceSelect.value = preselectedServiceId;
        serviceSelect.dispatchEvent(new Event('change'));
    }

    paymentDateInput.value = new Date().toISOString().slice(0, 16);

    serviceSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const valueUsd = parseFloat(selectedOption.dataset.valueUsd);
            const providerName = selectedOption.dataset.provider;
            
            document.getElementById('detail-provider').textContent = providerName;
            document.getElementById('detail-amount-usd').textContent = `{{ currency_symbol }}${valueUsd.toFixed(2)}`;
            document.getElementById('detail-amount-ves').textContent = `Bs. ${(valueUsd * currentRate).toFixed(2)}`;
            
            serviceDetailsDiv.classList.remove('hidden');
        } else {
            serviceDetailsDiv.classList.add('hidden');
        }
    });

    paymentMethodSelect.addEventListener('change', function() {
        const method = this.value;
        accountSelect.innerHTML = '<option value="">-- Seleccione una cuenta --</option>';
        accountSelect.disabled = true;

        if (method === 'bank') {
            banks.forEach(bank => {
                if (bank.currency === 'VES') { // Solo bancos en VES para pagos
                    accountSelect.innerHTML += `<option value="${bank.id}">${bank.name} (Saldo: Bs. ${parseFloat(bank.balance).toFixed(2)})</option>`;
                }
            });
            accountSelect.disabled = false;
        } else if (method === 'cash_ves') {
            cashBoxes.forEach(box => {
                accountSelect.innerHTML += `<option value="${box.id}">${box.name} (Saldo: Bs. ${parseFloat(box.balance_ves).toFixed(2)})</option>`;
            });
            accountSelect.disabled = false;
        } else if (method === 'cash_usd') {
            cashBoxes.forEach(box => {
                accountSelect.innerHTML += `<option value="${box.id}">${box.name} (Saldo: $ ${parseFloat(box.balance_usd).toFixed(2)})</option>`;
            });
            accountSelect.disabled = false;
        }
    });
});
</script>
{% endblock %}