{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4 max-w-7xl">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-user-tag mr-2"></i>{{ title }}</h1>
        <a href="{{ url_for('main.client_list') }}" class="text-blue-500 hover:underline"><i class="fas fa-arrow-left mr-1"></i> Volver a Clientes</a>
    </div>

    <!-- Client Info & Accounts Receivable Summary -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Client Info -->
        <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Información del Cliente</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-600">
                <p><strong>Nombre:</strong> {{ client.name }}</p>
                <p><strong>Cédula/RIF:</strong> {{ client.cedula_rif or 'N/A' }}</p>
                <p><strong>Email:</strong> {{ client.email or 'N/A' }}</p>
                <p><strong>Teléfono:</strong> {{ client.phone or 'N/A' }}</p>
                <p class="sm:col-span-2"><strong>Dirección:</strong> {{ client.address or 'N/A' }}</p>
                {% if is_administrador() %}
                <div class="sm:col-span-2 mt-4">
                    <a href="{{ url_for('main.edit_client', client_id=client.id) }}" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors text-sm"><i class="fas fa-edit mr-2"></i>Editar Cliente</a>
                </div>
                {% endif %}
                {% if client.associated_provider %}
                <div class="sm:col-span-2 mt-2 border-t pt-2">
                    <p><strong>Proveedor de Servicios Asociado:</strong> 
                        <a href="{{ url_for('main.provider_detail', provider_id=client.associated_provider.id) }}" class="text-blue-600 hover:underline">{{ client.associated_provider.name }}</a>
                    </p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Accounts Receivable -->
        <div class="bg-white p-6 rounded-lg shadow-md flex flex-col justify-center items-center text-center lg:col-span-1">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Cuentas por Cobrar</h2>
            {% if total_due > 0 %}
                {# La variable 'total_due' viene en USD desde la ruta #}
                <p class="text-4xl font-bold text-red-600">{{ currency_symbol }}{{ "%.2f"|format(total_due) }}</p>
                {% if current_rate > 0 %}
                <p class="text-lg text-gray-500 mt-1">(Aprox. Bs. {{ "%.2f"|format(total_due * current_rate) }})</p>
                {% else %}
                <p class="text-sm text-gray-500 mt-1">(Tasa de cambio no disponible)</p>
                {% endif %}
            {% else %}
                <p class="text-4xl font-bold text-green-600">Bs. 0.00</p>
                <p class="text-lg text-gray-500 mt-2">¡Cliente al día!</p>
            {% endif %}
        </div>

        <!-- Client Credit Balance -->
        <div class="bg-white p-6 rounded-lg shadow-md flex flex-col justify-between items-center text-center lg:col-span-1">
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Saldo a Favor</h2>
                {% if client_credit_balance_usd > 0 %}
                    <p class="text-4xl font-bold text-blue-600">{{ currency_symbol }}{{ "%.2f"|format(client_credit_balance_usd) }}</p>
                    <p class="text-lg text-gray-500 mt-2">Crédito disponible</p>
                {% else %}
                    <p class="text-4xl font-bold text-gray-500">{{ currency_symbol }}0.00</p>
                    <p class="text-lg text-gray-500 mt-2">Sin saldo a favor</p>
                {% endif %}
            </div>
            <a href="{{ url_for('main.new_credit_note', client_id=client.id) }}" class="mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors text-sm w-full"><i class="fas fa-plus-circle mr-2"></i>Generar Nota de Crédito</a>
        </div>
    </div>

    <!-- Order History -->
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Historial de Órdenes</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Orden #</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Pagado</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Deuda</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for order in orders %}
                    <tr class="{% if order.due_amount > 0.01 %}bg-red-50{% elif order.status == 'Pagada' %}bg-green-50{% endif %}">
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            <a href="{{ url_for('main.order_detail', order_id=order.id) }}" class="text-blue-600 hover:underline">#{{ order.id|order_id_format }}</a>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">{{ order.date_created|ve_datetime(fmt='%d/%m/%Y %H:%M') }}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-right text-gray-800">
                            <div>Bs. {{ "%.2f"|format(order.total_amount) }}</div>
                            <div class="text-xs text-gray-500">{{ currency_symbol }} {{ "%.2f"|format(order.total_amount_usd) }}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-right text-green-700">
                            <div>Bs. {{ "%.2f"|format(order.paid_amount) }}</div>
                            <div class="text-xs text-gray-500">{{ currency_symbol }} {{ "%.2f"|format(order.paid_amount_usd) }}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-right font-bold {% if order.due_amount > 0.01 %}text-red-600{% else %}text-gray-500{% endif %}">
                            <div>Bs. {{ "%.2f"|format(order.due_amount) }}</div>
                            <div class="text-xs {% if order.due_amount > 0.01 %}text-red-500{% else %}text-gray-500{% endif %}">{{ currency_symbol }} {{ "%.2f"|format(order.due_amount_usd) }}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-center text-sm">
                            {% if order.status == 'Crédito' %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Crédito</span>
                            {% elif order.status == 'Pagada' %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Pagada</span>
                            {% else %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">{{ order.status }}</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-center text-sm font-medium space-x-2">
                            <a href="{{ url_for('main.order_detail', order_id=order.id) }}" title="Ver Detalle" class="text-indigo-600 hover:text-indigo-900"><i class="fas fa-eye"></i></a>
                            {% if order.due_amount > 0.01 %}
                            <button type="button" class="text-green-600 hover:text-green-800 add-payment-button" 
                                    data-order-id="{{ order.id }}" 
                                    data-due-amount="{{ order.due_amount }}"
                                    title="Registrar Abono">
                                <i class="fas fa-hand-holding-usd"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="px-6 py-10 text-center text-gray-500">Este cliente aún no tiene órdenes registradas.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Hidden form for submitting payments -->
<form id="payment-submission-form" method="POST" action="{{ url_for('main.client_detail', client_id=client.id) }}" class="hidden">
    <input type="hidden" name="order_id" id="payment-form-order-id">
    <input type="hidden" name="payments_data" id="payment-form-data-input">
</form>


<!-- Include the generic payment modal -->
{% include 'shared/payment_modal.html' %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Payment Modal Logic ---
    const paymentSubmissionForm = document.getElementById('payment-submission-form');
    const paymentFormDataInput = document.getElementById('payment-form-data-input');
    const currencySymbol = '{{ currency_symbol }}';
    let payments = [];
    let orderTotal = 0;
    let currentRate = {{ current_rate }};
    let previousPaymentMethod;
    const providerBalance = parseFloat("{{ provider_balance_usd or 0 }}");
    const clientCreditBalance = parseFloat("{{ client_credit_balance_usd or 0 }}");


    function openPaymentModalForAbono(orderId, dueAmount) {
        // Define elements here, when the modal is about to be opened
        const paymentModal = document.getElementById('payment-modal');
        const paymentDateInput = document.getElementById('payment-date');
        const modalTotalAmount = document.getElementById('modal-total-amount');
        const modalTotalAmountUsd = document.getElementById('modal-total-amount-usd');
        const paymentFormOrderIdInput = document.getElementById('payment-form-order-id');
        const paymentMethodSelect = document.getElementById('payment-method');

        if (!paymentModal || !paymentMethodSelect || !paymentDateInput || !modalTotalAmount) {
            console.error("Payment modal elements not found!");
            alert("Error al abrir el modal de pago. Contacte al administrador.");
            return;
        }

        // Attach event listeners only once when the modal is first opened
        if (!paymentModal.dataset.listenersAttached) {
            attachModalEventListeners();
            paymentModal.dataset.listenersAttached = 'true';
        }

        // Reset state for new modal opening
        orderTotal = parseFloat(dueAmount);
        payments = []; // Reset payments for each new modal opening
        
        document.getElementById('payment-modal-title').textContent = `Registrar Abono para Orden #${String(orderId).padStart(9, '0')}`;
        document.getElementById('credit-sale-notice').classList.add('hidden');

        const finalizeOrderBtn = document.getElementById('finalize-order-btn');
        if (finalizeOrderBtn) finalizeOrderBtn.textContent = 'Registrar Abono';

        // Initialize previous values here, when the modal is open and elements exist
        previousPaymentMethod = paymentMethodSelect.value;

        // Set current date for the payment
        if (paymentDateInput) {
            paymentDateInput.value = new Date().toISOString().slice(0, 16);
        }

        paymentFormOrderIdInput.value = orderId;
        
        modalTotalAmount.textContent = orderTotal.toFixed(2) + ' Bs';
        modalTotalAmountUsd.textContent = (orderTotal / currentRate).toFixed(2) + ' ' + currencySymbol;

        // --- NEW: Handle Commercial Exchange option ---
        const commercialExchangeOption = document.querySelector('#payment-method option[value="intercambio_comercial"]');
        if (commercialExchangeOption) {
            if (providerBalance > 0) {
                commercialExchangeOption.style.display = '';
                commercialExchangeOption.textContent = `Intercambio Comercial (Saldo: $${providerBalance.toFixed(2)})`;
            } else {
                commercialExchangeOption.style.display = 'none';
            }
        }

        // --- NEW: Handle Client Credit option ---
        const clientCreditOption = document.querySelector('#payment-method option[value="credito_cliente"]');
        if (clientCreditOption) {
            if (clientCreditBalance > 0) {
                clientCreditOption.style.display = '';
                clientCreditOption.textContent = `Usar Crédito de Cliente (Saldo: $${clientCreditBalance.toFixed(2)})`;
            } else {
                clientCreditOption.style.display = 'none';
            }
        }


        updatePaymentSummary();
        paymentModal.classList.remove('hidden');

    }

    function closePaymentModal() {
        const paymentModal = document.getElementById('payment-modal');
        if (!paymentModal) return;
        paymentModal.classList.add('hidden');
    }

    function updatePaymentSummary() {
        const paymentMethodSelect = document.getElementById('payment-method');
        const paymentAmountInput = document.getElementById('payment-amount');
        const modalPaidAmount = document.getElementById('modal-paid-amount');
        const modalRemainingAmount = document.getElementById('modal-remaining-amount');
        const modalPaidAmountUsd = document.getElementById('modal-paid-amount-usd');
        const modalRemainingAmountUsd = document.getElementById('modal-remaining-amount-usd');
        const finalizeOrderBtn = document.getElementById('finalize-order-btn');
        if (!paymentMethodSelect) return;

        const totalPaid = payments.reduce((sum, p) => sum + p.amount_ves_equivalent, 0);
        const remaining = orderTotal - totalPaid;

        modalPaidAmount.textContent = totalPaid.toFixed(2) + ' Bs'; // Esto mostrará el abono actual
        modalPaidAmountUsd.textContent = (totalPaid / currentRate).toFixed(2) + ' ' + currencySymbol;

        modalRemainingAmount.textContent = Math.max(0, remaining).toFixed(2) + ' Bs'; // Esto mostrará el saldo después del abono
        modalRemainingAmountUsd.textContent = (Math.max(0, remaining) / currentRate).toFixed(2) + ' ' + currencySymbol;

        finalizeOrderBtn.disabled = totalPaid <= 0;
        if (!paymentAmountInput) return;
        
        // Auto-fill amount
        updatePaymentAmountInput(remaining);
    }

    function updatePaymentAmountInput(remaining) {
        const paymentMethodSelect = document.getElementById('payment-method');
        const paymentAmountInput = document.getElementById('payment-amount');
        if (remaining <= 0.01) {
            const paymentAmountInput = document.getElementById('payment-amount');
            if (!paymentAmountInput) return;
            paymentAmountInput.value = '';
            return;
        }
        const method = paymentMethodSelect.value;
        if (method === 'intercambio_comercial' && currentRate > 0) {
            const dueInUsd = remaining / currentRate;
            const amountToPay = Math.min(dueInUsd, providerBalance);
            paymentAmountInput.value = amountToPay.toFixed(2);
        } else if (method === 'efectivo_usd' && currentRate > 0) {
             paymentAmountInput.value = (remaining / currentRate).toFixed(2);
        } else {
            const remainingUsd = remaining / currentRate;
            const amountToPay = Math.min(remainingUsd, clientCreditBalance);
            paymentAmountInput.value = amountToPay.toFixed(2);
        } else {
            paymentAmountInput.value = remaining.toFixed(2);
        }
    }



    function addPayment() {
        const addPaymentBtnModal = document.getElementById('add-payment-btn-modal');
        const paymentMethodSelect = document.getElementById('payment-method');
        const paymentAmountInput = document.getElementById('payment-amount');
        const paymentDateInput = document.getElementById('payment-date');

        if (!addPaymentBtnModal || !paymentMethodSelect || !paymentAmountInput || !paymentDateInput) return;

        // This modal only allows one payment at a time for simplicity
        payments = [];
        
        // Cambiar el texto del botón para que sea más intuitivo
        addPaymentBtnModal.textContent = 'Actualizar Datos del Abono';

        const method = paymentMethodSelect.value;
        const amount = parseFloat(paymentAmountInput.value);
        const paymentCurrencySelect = document.getElementById('payment-currency'); // May be null
        
        const paymentDate = paymentDateInput.value;
        const issuingBank = document.getElementById('payment-issuing-bank').value;
        const senderId = document.getElementById('payment-sender-id').value;

        if (!amount || amount <= 0) {
            alert("Por favor, ingrese un monto válido.");
            return;
        }

        let amount_ves_equivalent = amount;
        let currency_paid = 'VES';
        const transfer_currency = paymentCurrencySelect ? paymentCurrencySelect.value : 'VES';
        
        // VALIDATION
        if (method === 'intercambio_comercial' && amount > providerBalance) {
            alert(`El monto a utilizar (${amount.toFixed(2)} USD) excede el saldo del proveedor (${providerBalance.toFixed(2)} USD).`);
            return;
        }
        if (method === 'credito_cliente' && amount > clientCreditBalance) {
            alert(`El monto a utilizar (${amount.toFixed(2)} USD) excede el saldo a favor del cliente (${clientCreditBalance.toFixed(2)} USD).`);
            return;
        }
        if (['efectivo_usd', 'intercambio_comercial', 'credito_cliente'].includes(method) || (method === 'transferencia' && transfer_currency === 'USD')) {
            amount_ves_equivalent = amount * currentRate;
            currency_paid = 'USD';
        }

        const payment = {
            method: method,
            amount_paid: amount,
            currency_paid: currency_paid,
            amount_ves_equivalent: amount_ves_equivalent,
            reference: document.getElementById('payment-reference').value,
            date: paymentDate,
            issuing_bank: issuingBank,
            sender_id: senderId,
            bank_id: document.getElementById('payment-bank').value ? parseInt(document.getElementById('payment-bank').value) : null,
            pos_id: document.getElementById('payment-pos').value ? parseInt(document.getElementById('payment-pos').value) : null,
            provider_id: (method === 'intercambio_comercial' && {{ client.associated_provider.id or 'null' }}) ? {{ client.associated_provider.id }} : null,
            cash_box_id: document.getElementById('payment-cashbox').value ? parseInt(document.getElementById('payment-cashbox').value) : null,
        };
        payments.push(payment);
        updatePaymentSummary();
    }

    // --- Initial Event Listeners (for buttons outside the modal) ---
    document.querySelectorAll('.add-payment-button').forEach(button => {
        button.addEventListener('click', function() {
            const orderId = this.dataset.orderId;
            const dueAmount = this.dataset.dueAmount;
            openPaymentModalForAbono(orderId, dueAmount);
        });
    });

    // This function attaches event listeners to modal elements.
    // It's called only once to avoid duplicating listeners.
    function attachModalEventListeners() {
        const closeModalBtn = document.getElementById('close-modal-btn');
        const addPaymentBtnModal = document.getElementById('add-payment-btn-modal');
        const paymentMethodSelect = document.getElementById('payment-method');
        const paymentAmountInput = document.getElementById('payment-amount');
        const paymentCurrencySelect = document.getElementById('payment-currency'); // May be null        
        const finalizeOrderBtn = document.getElementById('finalize-order-btn');

        if (!closeModalBtn || !addPaymentBtnModal || !paymentMethodSelect || !finalizeOrderBtn) return;

        closeModalBtn.addEventListener('click', closePaymentModal);
        addPaymentBtnModal.addEventListener('click', addPayment);

        paymentMethodSelect.addEventListener('change', function() {
            const newMethod = this.value;
            const amount = parseFloat(paymentAmountInput.value);

            const paymentReferenceGroup = document.getElementById('payment-reference-group');
            const paymentIssuingBankGroup = document.getElementById('payment-issuing-bank-group');
            const paymentSenderIdGroup = document.getElementById('payment-sender-id-group');
            const paymentBankGroup = document.getElementById('payment-bank-group');
            const paymentPosGroup = document.getElementById('payment-pos-group');
            const paymentCashboxGroup = document.getElementById('payment-cashbox-group');
            const paymentCurrencyGroup = document.getElementById('payment-currency-group'); // May be null
            const paymentClientCreditGroup = document.getElementById('payment-client-credit-group');

            function filterBankOptions() {
                const selectedCurrency = paymentCurrencySelect ? paymentCurrencySelect.value : 'VES';
                const paymentBankSelect = document.getElementById('payment-bank');
                if (!paymentBankSelect) return;
                const bankOptions = paymentBankSelect.options;
                for (let i = 1; i < bankOptions.length; i++) { // Skip "Seleccione un banco"
                    const option = bankOptions[i];
                    if (option.dataset.currency === selectedCurrency) {
                        option.style.display = '';
                    } else {
                        option.style.display = 'none';
                    }
                }
                if (paymentBankSelect.selectedOptions.length > 0 && paymentBankSelect.selectedOptions[0].style.display === 'none') {
                    paymentBankSelect.value = '';
                }
            }

            // --- NEW: Handle Commercial Exchange UI ---
            const isExchange = newMethod === 'intercambio_comercial';
            const paymentProviderGroup = document.getElementById('payment-provider-group'); // This is the container for the info
            if (paymentProviderGroup) {
                paymentProviderGroup.classList.toggle('hidden', !isExchange);
                if (isExchange) {
                    const providerInfoDiv = document.getElementById('provider-info-display');
                    const noProviderMsg = document.getElementById('no-provider-message');
                    if (providerBalance > 0) {
                        document.getElementById('provider-name-display').textContent = {{ client.associated_provider.name|tojson if client.associated_provider else 'null' }};
                        document.getElementById('provider-balance-display').textContent = `${currencySymbol}${providerBalance.toFixed(2)}`;
                        providerInfoDiv.classList.remove('hidden');
                        noProviderMsg.classList.add('hidden');
                    } else {
                        noProviderMsg.textContent = 'El cliente no tiene un proveedor asociado con saldo disponible.';
                        providerInfoDiv.classList.add('hidden');
                        noProviderMsg.classList.remove('hidden');
                    }
                }
            }
            // --- End of new UI handling ---

            // --- NEW: Handle Client Credit UI ---
            const isClientCredit = newMethod === 'credito_cliente';
            if (paymentClientCreditGroup) {
                paymentClientCreditGroup.classList.toggle('hidden', !isClientCredit);
                if (isClientCredit) {
                    const creditInfoDiv = document.getElementById('client-credit-info-display');
                    const noCreditMsg = document.getElementById('no-client-credit-message');
                    if (clientCreditBalance > 0) {
                        document.getElementById('client-credit-balance-display').textContent = `${currencySymbol}${clientCreditBalance.toFixed(2)}`;
                        creditInfoDiv.classList.remove('hidden');
                        noCreditMsg.classList.add('hidden');
                    } else {
                        noCreditMsg.textContent = 'El cliente no tiene saldo a favor disponible.';
                        creditInfoDiv.classList.add('hidden');
                        noCreditMsg.classList.remove('hidden');
                    }
                }
            }
            // --- End of Client Credit UI ---

            const isTransfer = newMethod === 'transferencia';
            [paymentReferenceGroup, paymentIssuingBankGroup, paymentSenderIdGroup, paymentBankGroup].forEach(el => el && el.classList.toggle('hidden', !isTransfer));
            if (paymentCurrencyGroup) paymentCurrencyGroup.classList.toggle('hidden', !isTransfer);
            if (paymentPosGroup) paymentPosGroup.classList.toggle('hidden', newMethod !== 'punto_de_venta');
            if (paymentCashboxGroup) paymentCashboxGroup.classList.toggle('hidden', !newMethod.startsWith('efectivo'));
            
            


            if (isTransfer) {
                document.getElementById('payment-sender-id').value = '{{ client.phone or '' }}';
                filterBankOptions();
            }

            if (amount && amount > 0 && currentRate > 0) {
                const wasUsd = ['efectivo_usd', 'intercambio_comercial', 'credito_cliente'].includes(previousPaymentMethod) || (previousPaymentMethod === 'transferencia' && document.getElementById('payment-currency')?.value === 'USD');
                const isUsd = ['efectivo_usd', 'intercambio_comercial', 'credito_cliente'].includes(newMethod) || (isTransfer && paymentCurrencySelect?.value === 'USD');
                if (wasUsd && !isUsd) { // USD -> VES
                    paymentAmountInput.value = (amount * currentRate).toFixed(2);
                } else if (!wasUsd && isUsd) { // VES -> USD
                    paymentAmountInput.value = (amount / currentRate).toFixed(2);
                }
            } else {
                updatePaymentSummary();
            }
            previousPaymentMethod = newMethod;
        });

        if (paymentCurrencySelect) {
            paymentCurrencySelect.addEventListener('change', function() {
                paymentMethodSelect.dispatchEvent(new Event('change'));
            });
        }

        finalizeOrderBtn.addEventListener('click', function() {
            if (payments.length === 0) {
                // Si no hay pagos en el array, intenta agregarlo desde los campos del formulario.
                addPayment();
            }
            if (payments.length === 0) {
                alert("Debe agregar al menos un método de pago para registrar el abono.");
                return;
            }
            paymentFormDataInput.value = JSON.stringify(payments);
            paymentSubmissionForm.submit();
        });

        // Initialize first state of conditional fields
        paymentMethodSelect.dispatchEvent(new Event('change'));
    }
});
</script>

{% endblock %}