{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4 max-w-4xl">
    <div class="flex items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-cart-plus mr-2"></i>Crear Nueva Orden de Venta</h1>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
        <form method="POST" action="{{ url_for('main.new_order') }}">
            <!-- Información de la orden -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Información de la Orden</h2>
                <label for="client_id" class="block text-gray-700 font-bold mb-2">Cliente:</label>
                <select id="client_id" name="client_id" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    {% for client in clients %}
                        <option value="{{ client.id }}">{{ client.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Escáner de código de barras -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Escáner de Código de Barras</h2>
                <div class="flex items-center space-x-4">
                    <input type="text" id="barcode-input" placeholder="Escanea o ingresa código de barras" class="flex-1 shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="button" id="scan-barcode-btn" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-barcode mr-2"></i>Agregar Producto
                    </button>
                </div>
            </div>

            <!-- Lista de productos -->
            <div id="product-list" class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Productos</h2>
                <div class="space-y-4">
                    <!-- Fila de ejemplo para clonar -->
                    <div class="product-item flex items-center space-x-4 border p-4 rounded-lg bg-gray-50">
                        <div class="flex-1">
                            <select name="product_id[]" required class="w-full shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 product-select">
                                {% for product in products %}
                                    <option value="{{ product.id }}" data-price-usd="{{ product.price_usd }}" data-stock="{{ product.stock }}" data-codigo="{{ product.codigo_producto }}">{{ product.name }} (Stock: {{ product.stock }})</option>
                                {% endfor %}
                            </select>
                            <div class="text-sm text-gray-500 mt-1 codigo-producto-display"></div>
                        </div>
                        <input type="number" name="quantity[]" placeholder="Cantidad" min="1" required class="w-24 shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 quantity-input">
                        
                        <div class="flex flex-col">
                            <label class="text-sm text-gray-500">USD</label>
                            <input type="number" name="price_usd[]" placeholder="Precio USD" step="0.01" min="0" required class="w-24 shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 price-usd-input">
                        </div>
                        <div class="flex flex-col">
                            <label class="text-sm text-gray-500">Bs</label>
                            <span class="price-ves-display w-24 text-center font-bold text-gray-800">0.00</span>
                        </div>
                        
                        <button type="button" class="bg-red-500 text-white p-2 rounded remove-product-btn hover:bg-red-600 transition-colors"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="mt-4">
                    <button type="button" id="add-product-btn" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Agregar Otro Producto
                    </button>
                </div>
            </div>

            <!-- Resumen de la orden -->
            <div class="border-t pt-4 mb-6">
                <div class="grid grid-cols-2 gap-4 max-w-md ml-auto">
                    <div class="text-right font-semibold">Subtotal:</div>
                    <div class="text-right" id="subtotal-display">0.00 Bs</div>
                    
                    <div class="text-right font-semibold">IVA (16%):</div>
                    <div class="text-right" id="iva-display">0.00 Bs</div>
                    
                    <div class="text-right font-bold text-lg border-t pt-2">Total:</div>
                    <div class="text-right font-bold text-lg border-t pt-2" id="total-display">0.00 Bs</div>
                </div>
            </div>

            <div class="flex items-center justify-end">
                <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">
                    <i class="fas fa-save mr-2"></i>Crear Orden
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const productList = document.querySelector('#product-list .space-y-4');
        const addProductBtn = document.getElementById('add-product-btn');
        let currentRate = {{ current_rate }};

        // Función para actualizar el precio en Bolívares
        function updatePriceVes(priceUsdInput) {
            const priceUsd = parseFloat(priceUsdInput.value) || 0;
            const priceVesDisplay = priceUsdInput.closest('.product-item').querySelector('.price-ves-display');
            const priceVes = (priceUsd * currentRate).toFixed(2);
            priceVesDisplay.textContent = priceVes;
        }

        // Función para inicializar los precios y el stock
        function initializeProductItem(productItem) {
            const selectElement = productItem.querySelector('.product-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const priceUsdInput = productItem.querySelector('.price-usd-input');
            
            // Asignar el precio USD desde el atributo data-
            priceUsdInput.value = selectedOption.dataset.priceUsd;
            updatePriceVes(priceUsdInput);
            
            // Actualizar el stock en la etiqueta del producto
            const productName = selectedOption.text.split(' (')[0];
            selectedOption.text = `${productName} (Stock: ${selectedOption.dataset.stock})`;
        }

        // Event listener para actualizar el precio en Bs al cambiar el producto
        productList.addEventListener('change', function(event) {
            if (event.target.classList.contains('product-select')) {
                initializeProductItem(event.target.closest('.product-item'));
            }
        });
        
        // Event listener para recalcular el precio en Bs cuando se edita el precio USD
        productList.addEventListener('input', function(event) {
            if (event.target.classList.contains('price-usd-input')) {
                updatePriceVes(event.target);
            }
        });

        // Inicializar el primer producto
        document.querySelectorAll('.product-item').forEach(initializeProductItem);

        // Event listener para agregar un nuevo producto
        addProductBtn.addEventListener('click', function() {
            const firstProductItem = productList.querySelector('.product-item');
            const newProductItem = firstProductItem.cloneNode(true);
            
            // Limpiar valores del nuevo clon
            newProductItem.querySelector('.product-select').selectedIndex = 0;
            newProductItem.querySelector('.quantity-input').value = '';
            newProductItem.querySelector('.price-usd-input').value = '';

            // Habilitar el botón de eliminar
            const removeBtn = newProductItem.querySelector('.remove-product-btn');
            removeBtn.disabled = false;
            removeBtn.style.display = 'inline-block';

            // Inicializar el nuevo clon
            initializeProductItem(newProductItem);
            
            productList.appendChild(newProductItem);
        });

        // Event listener para eliminar una fila de producto
        productList.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-product-btn') || event.target.closest('.remove-product-btn')) {
                const productItem = event.target.closest('.product-item');
                if (productList.childElementCount > 1) {
                    productItem.remove();
                    updateOrderSummary();
                }
            }
        });

        // Función para actualizar el código del producto
        function updateProductCodeDisplay(productItem) {
            const selectElement = productItem.querySelector('.product-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const codigoDisplay = productItem.querySelector('.codigo-producto-display');
            const codigo = selectedOption.dataset.codigo || 'Sin código';
            codigoDisplay.textContent = `Código: ${codigo}`;
        }

        // Actualizar códigos de producto al inicializar
        document.querySelectorAll('.product-item').forEach(updateProductCodeDisplay);

        // Event listener para actualizar código al cambiar producto
        productList.addEventListener('change', function(event) {
            if (event.target.classList.contains('product-select')) {
                updateProductCodeDisplay(event.target.closest('.product-item'));
                updateOrderSummary();
            }
        });

        // Event listener para actualizar resumen al cambiar cantidad o precio
        productList.addEventListener('input', function(event) {
            if (event.target.classList.contains('quantity-input') || event.target.classList.contains('price-usd-input')) {
                updateOrderSummary();
            }
        });

        // Función para calcular y actualizar el resumen de la orden
        function updateOrderSummary() {
            let subtotal = 0;
            
            document.querySelectorAll('.product-item').forEach(productItem => {
                const quantity = parseFloat(productItem.querySelector('.quantity-input').value) || 0;
                const priceUsd = parseFloat(productItem.querySelector('.price-usd-input').value) || 0;
                const priceVes = priceUsd * currentRate;
                
                subtotal += quantity * priceVes;
            });

            const iva = subtotal * 0.16;
            const total = subtotal + iva;

            document.getElementById('subtotal-display').textContent = subtotal.toFixed(2) + ' Bs';
            document.getElementById('iva-display').textContent = iva.toFixed(2) + ' Bs';
            document.getElementById('total-display').textContent = total.toFixed(2) + ' Bs';
        }

        // Inicializar resumen de la orden
        updateOrderSummary();

        // Función para agregar producto por código de barras
        document.getElementById('scan-barcode-btn').addEventListener('click', function() {
            const barcode = document.getElementById('barcode-input').value.trim();
            if (!barcode) {
                alert('Por favor ingrese un código de barras');
                return;
            }

            fetch(`/api/product_by_barcode/${barcode}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Producto no encontrado');
                    }
                    return response.json();
                })
                .then(product => {
                    // Crear nueva fila de producto
                    const firstProductItem = productList.querySelector('.product-item');
                    const newProductItem = firstProductItem.cloneNode(true);
                    
                    // Seleccionar el producto en el dropdown
                    const selectElement = newProductItem.querySelector('.product-select');
                    for (let i = 0; i < selectElement.options.length; i++) {
                        if (selectElement.options[i].value == product.id) {
                            selectElement.selectedIndex = i;
                            break;
                        }
                    }

                    // Limpiar otros valores
                    newProductItem.querySelector('.quantity-input').value = '1';
                    newProductItem.querySelector('.price-usd-input').value = product.price_usd;

                    // Habilitar botón de eliminar
                    const removeBtn = newProductItem.querySelector('.remove-product-btn');
                    removeBtn.disabled = false;
                    removeBtn.style.display = 'inline-block';

                    // Inicializar el nuevo producto
                    initializeProductItem(newProductItem);
                    updateProductCodeDisplay(newProductItem);
                    
                    // Agregar a la lista
                    productList.appendChild(newProductItem);
                    
                    // Actualizar resumen
                    updateOrderSummary();
                    
                    // Limpiar input de código de barras
                    document.getElementById('barcode-input').value = '';
                    document.getElementById('barcode-input').focus();
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                    document.getElementById('barcode-input').focus();
                });
        });

        // Permitir agregar producto con Enter en el input de código de barras
        document.getElementById('barcode-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('scan-barcode-btn').click();
            }
        });
    });
</script>
{% endblock %}