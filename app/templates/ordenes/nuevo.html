{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4 max-w-4xl">
    <div class="flex items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-cart-plus mr-2"></i>Crear Nueva Orden de Venta</h1>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
        <form method="POST" action="{{ url_for('main.new_order') }}" id="order-form">
            <!-- Información de la orden y escáner -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Información de la Orden</h2>

                <div class="flex justify-between items-start">
                    <!-- Información del cliente -->
                    <div class="w-1/2 pr-4">
                        <label for="client_search" class="block text-gray-700 font-bold mb-2">Cliente (Cédula o RIF):</label>
                        <input type="text" id="client_search" name="client_search" autocomplete="off" placeholder="Escribe cédula o RIF para buscar cliente" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <input type="hidden" id="client_id" name="client_id" required>
                        <div id="client_suggestions" class="border border-gray-300 rounded mt-1 max-h-32 overflow-y-auto bg-white hidden"></div>
                        <div id="client_info" class="mt-3 p-3 border border-gray-300 rounded bg-gray-50 hidden">
                            <div class="font-semibold mb-1">Cliente Seleccionado:</div>
                            <div><strong>Nombre:</strong> <span id="client_name"></span></div>
                            <div><strong>Cédula/RIF:</strong> <span id="client_cedula_rif"></span></div>
                            <div><strong>Email:</strong> <span id="client_email"></span></div>
                            <div><strong>Teléfono:</strong> <span id="client_phone"></span></div>
                            <div><strong>Dirección:</strong> <span id="client_address"></span></div>
                        </div>
                    </div>

                    <!-- Escáner de código de barras y agregar producto -->
                    <div class="w-1/2 pl-4">
                        <label class="block text-gray-700 font-bold mb-2">Escáner de Código de Barras:</label>
                        <div class="flex items-center space-x-2 mb-4">
                            <input type="text" id="barcode-input" placeholder="Código de barras" class="flex-1 shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" id="scan-barcode-btn" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition-colors">
                                <i class="fas fa-barcode mr-1"></i>Agregar
                            </button>
                        </div>
                        <button type="button" id="add-product-btn" class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Agregar Otro Producto
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista de productos -->
            <div id="product-list" class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Productos</h2>
                <table class="table table-compact w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-2 py-1 text-left">Producto</th>
                            <th class="border border-gray-300 px-2 py-1 text-left">Cantidad</th>
                            <th class="border border-gray-300 px-2 py-1 text-left">Precio USD</th>
                            <th class="border border-gray-300 px-2 py-1 text-left">Precio Bs</th>
                            <th class="border border-gray-300 px-2 py-1 text-left">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Fila de ejemplo para clonar -->
                        <tr class="product-item bg-gray-50">
                            <td class="px-2 py-1">
                                <select name="product_id[]" required class="w-full shadow appearance-none border rounded py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 product-select">
                                    {% for product in products %}
                                        {% if product.stock > 0 %}
                                            <option value="{{ product.id }}" data-price-usd="{{ product.price_usd }}" data-stock="{{ product.stock }}" data-codigo="{{ product.codigo_producto }}"
                                                    class="{% if product.stock < 5 %}stock-low{% elif product.stock < 20 %}stock-medium{% else %}stock-high{% endif %}">
                                                {{ product.name }} (Stock: {{ product.stock }})
                                                {% if product.stock < 5 %}
                                                    <span class="text-red-600 font-bold">⚠️ STOCK BAJO</span>
                                                {% elif product.stock < 20 %}
                                                    <span class="text-yellow-600">⚡ STOCK MEDIO</span>
                                                {% else %}
                                                    <span class="text-green-600">✅ STOCK BUENO</span>
                                                {% endif %}
                                            </option>
                                        {% else %}
                                            <option value="{{ product.id }}" disabled data-price-usd="{{ product.price_usd }}" data-stock="{{ product.stock }}" data-codigo="{{ product.codigo_producto }}" class="stock-out">
                                                {{ product.name }} (AGOTADO - Stock: {{ product.stock }})
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <div class="text-sm text-gray-500 mt-1 codigo-producto-display"></div>
                            </td>
                            <td class="px-2 py-1">
                                <input type="number" name="quantity[]" placeholder="Cantidad" min="1" required class="w-24 shadow appearance-none border rounded py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 quantity-input">
                            </td>
                            <td class="px-2 py-1">
                                {% if current_user.is_authenticated and current_user.role == 'administrador' %}
                                <input type="number" name="price_usd[]" placeholder="Precio" step="0.01" min="0" required class="w-24 shadow appearance-none border rounded py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 price-usd-input">
                                {% else %}
                                <span class="w-24 text-center font-bold text-gray-800 price-usd-display">0.00</span>
                                <input type="hidden" name="price_usd[]" class="price-usd-hidden-for-submit">
                                {% endif %}
                            </td>
                            <td class="px-2 py-1 text-center font-bold text-gray-800 price-ves-display">0.00</td>
                            <td class="px-2 py-1 text-center">
                                <button type="button" class="bg-red-500 text-white py-1 px-2 rounded remove-product-btn hover:bg-red-600 transition-colors"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Resumen de la orden -->
            <div class="border-t pt-4 mb-6">
                <div class="grid grid-cols-2 gap-4 max-w-md ml-auto">
                    <div class="text-right font-semibold hidden">Subtotal:</div>
                    <div class="text-right hidden" id="subtotal-display">0.00 Bs</div>
                    
                    <div class="text-right font-semibold hidden">IVA (16%):</div>
                    <div class="text-right hidden" id="iva-display">0.00 Bs</div>
                    
                    <div class="text-right font-bold text-lg border-t pt-2">Total a Pagar:</div>
                    <div class="text-right font-bold text-lg border-t pt-2" id="total-display">0.00 Bs</div>
                </div>
            </div>

            <div class="flex items-center justify-between mt-6 pt-6 border-t">
                <!-- Botón para reimprimir la última orden -->
                <div>
                    {% if last_order %}
                    <a href="{{ url_for('main.print_delivery_note', order_id=last_order.id) }}" target="_blank" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">
                        <i class="fas fa-print mr-2"></i>Reimprimir Última Orden (#{{ last_order.id|order_id_format }})
                    </a>
                    {% endif %}
                </div>

                <!-- Botón para procesar el pago de la nueva orden -->
                <div>
                    <input type="hidden" name="payments_data" id="payments-data-input">
                    <button type="button" id="process-payment-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">
                        <i class="fas fa-dollar-sign mr-2"></i>Procesar Pago y Crear Orden
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Payment Modal -->
<div id="payment-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl leading-6 font-medium text-gray-900">Registrar Pago</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Resumen de Pago -->
            <div class="bg-blue-50 p-4 rounded-lg mb-6 text-center">
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">Total a Pagar</p>
                        <p id="modal-total-amount" class="text-2xl font-bold text-blue-800">0.00 Bs</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Total Pagado</p>
                        <p id="modal-paid-amount" class="text-2xl font-bold text-green-600">0.00 Bs</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Monto Restante</p>
                        <p id="modal-remaining-amount" class="text-2xl font-bold text-red-600">0.00 Bs</p>
                    </div>
                </div>
                <!-- Vuelto Display -->
                <div id="modal-change-display" class="mt-4 hidden text-center">
                    <p class="text-lg text-gray-700">Vuelto a entregar:</p>
                    <p id="modal-change-amount" class="text-3xl font-bold text-yellow-600">0.00</p>
                </div>
            </div>

            <!-- Formulario para agregar pago -->
            <div id="add-payment-form" class="border p-4 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                    <label for="payment-method" class="block text-sm font-medium text-gray-700">Método de Pago</label>
                    <select id="payment-method" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="efectivo_ves">Efectivo (Bs)</option>
                        <option value="efectivo_usd">Efectivo (USD)</option>
                        <option value="transferencia">Transferencia/Pago Móvil</option>
                        <option value="punto_de_venta">Punto de Venta</option>
                    </select>
                    </div>
                    <div>
                    <label for="payment-amount" class="block text-sm font-medium text-gray-700">Monto</label>
                    <input type="number" id="payment-amount" step="0.01" min="0.01" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div class="md:col-span-1"></div> <!-- Spacer -->
                </div>
                
                <!-- Campos condicionales -->
                <div id="payment-details-group" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div id="payment-reference-group" class="hidden">
                        <label for="payment-reference" class="block text-sm font-medium text-gray-700">Referencia</label>
                        <input type="text" id="payment-reference" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div id="payment-bank-group" class="hidden">
                        <label for="payment-bank" class="block text-sm font-medium text-gray-700">Banco Destino</label>
                        <select id="payment-bank" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="">Seleccione un banco</option>
                            {% for bank in banks %}<option value="{{ bank.id }}">{{ bank.name }}</option>{% endfor %}
                        </select>
                    </div>
                    <div id="payment-pos-group" class="hidden">
                        <label for="payment-pos" class="block text-sm font-medium text-gray-700">Punto de Venta</label>
                        <select id="payment-pos" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="">Seleccione un POS</option>
                            {% for pos in points_of_sale %}<option value="{{ pos.id }}">{{ pos.name }}</option>{% endfor %}
                        </select>
                    </div>
                    <div id="payment-cashbox-group" class="hidden">
                        <label for="payment-cashbox" class="block text-sm font-medium text-gray-700">Caja</label>
                        <select id="payment-cashbox" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="">Seleccione una caja</option>
                            {% for box in cash_boxes %}<option value="{{ box.id }}">{{ box.name }}</option>{% endfor %}
                        </select>
                    </div>
                </div>

                <div class="flex justify-end mt-4">
                    <button type="button" id="add-payment-btn-modal" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">
                        <i class="fas fa-plus mr-2"></i>Agregar Pago
                    </button>
                </div>
            </div>

            <!-- Lista de pagos agregados -->
            <div class="mt-6">
                <h4 class="text-lg font-medium text-gray-800 mb-2">Pagos Registrados</h4>
                <div id="payments-list" class="space-y-2">
                    <!-- Los pagos se agregarán aquí dinámicamente -->
                </div>
            </div>

            <!-- Botón de Finalizar -->
            <div class="mt-8 flex justify-end">
                <button type="button" id="finalize-order-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 disabled:bg-gray-400" disabled>
                    <i class="fas fa-check-circle mr-2"></i>Finalizar y Crear Orden
                </button>
            </div>
        </div>
    </div>
</div>

<!-- New Client Modal -->
<div id="new-client-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl leading-6 font-medium text-gray-900">Crear Nuevo Cliente</h3>
                <button id="close-new-client-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="new-client-modal-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden" role="alert">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline" id="new-client-modal-error-message"></span>
            </div>
            <form id="new-client-form">
                <div class="space-y-4">
                    <div>
                        <label for="new-client-name" class="block text-sm font-medium text-gray-700">Nombre Completo o Razón Social</label>
                        <input type="text" id="new-client-name" name="name" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new-client-cedula-rif" class="block text-sm font-medium text-gray-700">Cédula o RIF</label>
                        <input type="text" id="new-client-cedula-rif" name="cedula_rif" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new-client-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="new-client-email" name="email" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new-client-phone" class="block text-sm font-medium text-gray-700">Teléfono</label>
                        <input type="tel" id="new-client-phone" name="phone" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new-client-address" class="block text-sm font-medium text-gray-700">Dirección</label>
                        <textarea id="new-client-address" name="address" rows="2" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                    </div>
                </div>
                <div class="mt-8 flex justify-end">
                    <button type="button" id="cancel-new-client-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 mr-4">Cancelar</button>
                    <button type="button" id="save-new-client-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i>Guardar Cliente</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const clientSearchInput = document.getElementById('client_search');
        const clientSuggestions = document.getElementById('client_suggestions');
        const clientIdInput = document.getElementById('client_id');
        const clientInfoDiv = document.getElementById('client_info');
        const clientNameSpan = document.getElementById('client_name');
        const clientCedulaRifSpan = document.getElementById('client_cedula_rif');
        const clientEmailSpan = document.getElementById('client_email');
        const clientPhoneSpan = document.getElementById('client_phone');
        const clientAddressSpan = document.getElementById('client_address');

        const newClientModal = document.getElementById('new-client-modal');
        const closeNewClientModalBtn = document.getElementById('close-new-client-modal-btn');
        const cancelNewClientBtn = document.getElementById('cancel-new-client-btn');
        const saveNewClientBtn = document.getElementById('save-new-client-btn');
        const newClientForm = document.getElementById('new-client-form');
        const newClientModalError = document.getElementById('new-client-modal-error');
        const newClientModalErrorMessage = document.getElementById('new-client-modal-error-message');

        let selectedClient = null;
        let debounceTimeout = null;

        function clearClientInfo() {
            clientNameSpan.textContent = '';
            clientCedulaRifSpan.textContent = '';
            clientEmailSpan.textContent = '';
            clientInfoDiv.classList.add('hidden');
            clientIdInput.value = '';
            selectedClient = null;
        }

        function showClientInfo(client) {
            clientNameSpan.textContent = client.name || '';
            clientCedulaRifSpan.textContent = client.cedula_rif || '';
            clientEmailSpan.textContent = client.email || '';
            clientPhoneSpan.textContent = client.phone || '';
            clientAddressSpan.textContent = client.address || '';
            clientInfoDiv.classList.remove('hidden');
            clientIdInput.value = client.id;
            selectedClient = client;
        }

        function fetchClientSuggestions(query) {
            fetch(`/api/search_clients?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    clientSuggestions.innerHTML = '';
                    if (data.clients.length > 0) {
                        data.clients.forEach(client => {
                            const div = document.createElement('div');
                            div.textContent = `${client.name} - ${client.cedula_rif || 'Sin Cédula/RIF'}`;
                            div.classList.add('cursor-pointer', 'px-3', 'py-1', 'hover:bg-blue-200');
                            div.dataset.client = JSON.stringify(client); // Store client data
                            div.addEventListener('click', () => {
                                clientSearchInput.value = `${client.name} - ${client.cedula_rif || ''}`;
                                clientSuggestions.classList.add('hidden');
                                showClientInfo(client);
                            });
                            clientSuggestions.appendChild(div);
                        });
                        clientSuggestions.classList.remove('hidden');
                    } else {
                        clientSuggestions.classList.add('hidden');
                        clearClientInfo();
                    }
                })
                .catch(() => {
                    clientSuggestions.classList.add('hidden');
                    clearClientInfo();
                });
        }

        clientSearchInput.addEventListener('input', () => {
            const query = clientSearchInput.value.trim();
            clearClientInfo();
            clientIdInput.value = '';
            if (debounceTimeout) {
                clearTimeout(debounceTimeout);
            }
            if (query.length === 0) {
                clientSuggestions.classList.add('hidden');
                return;
            }
            debounceTimeout = setTimeout(() => {
                fetchClientSuggestions(query);
            }, 300);
        });

        clientSearchInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                const query = clientSearchInput.value.trim();
                if (query.length === 0) return;

                // If a client is already selected, do nothing on Enter
                if (selectedClient) return;

                // Check if there are visible suggestions
                const firstSuggestion = clientSuggestions.querySelector('div');
                if (firstSuggestion) {
                    // Select the first suggestion
                    const clientData = JSON.parse(firstSuggestion.dataset.client || '{}');
                    if (clientData.id) {
                        clientSearchInput.value = `${clientData.name} - ${clientData.cedula_rif || ''}`;
                        clientSuggestions.classList.add('hidden');
                        showClientInfo(clientData);
                    }
                } else {
                    // No suggestions, open the 'create new client' modal
                    openNewClientModal();
                }
            }
        });

        function openNewClientModal() {
            const searchText = clientSearchInput.value.trim();
            // Reset form
            newClientForm.reset();
            newClientModalError.classList.add('hidden');

            // Pre-populate based on search text (very basic check for number)
            if (!isNaN(searchText) && !isNaN(parseFloat(searchText))) {
                document.getElementById('new-client-cedula-rif').value = searchText;
            } else {
                document.getElementById('new-client-name').value = searchText;
            }
            newClientModal.classList.remove('hidden');
            document.getElementById('new-client-name').focus();
        }

        function closeNewClientModal() {
            newClientModal.classList.add('hidden');
        }

        // Add listeners for the new client modal
        closeNewClientModalBtn.addEventListener('click', closeNewClientModal);
        cancelNewClientBtn.addEventListener('click', closeNewClientModal);

        saveNewClientBtn.addEventListener('click', () => {
            const name = document.getElementById('new-client-name').value.trim();
            if (!name) {
                newClientModalErrorMessage.textContent = 'El nombre del cliente es obligatorio.';
                newClientModalError.classList.remove('hidden');
                return;
            }

            const clientData = {
                name: name,
                cedula_rif: document.getElementById('new-client-cedula-rif').value.trim(),
                email: document.getElementById('new-client-email').value.trim(),
                phone: document.getElementById('new-client-phone').value.trim(),
                address: document.getElementById('new-client-address').value.trim(),
            };

            fetch('/api/clientes/nuevo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(clientData)
            })
            .then(response => {
                if (!response.ok) { return response.json().then(err => { throw new Error(err.error || 'Error desconocido'); }); }
                return response.json();
            })
            .then(newClient => {
                closeNewClientModal();
                showClientInfo(newClient);
                clientSearchInput.value = `${newClient.name} - ${newClient.cedula_rif || ''}`;
                clientSuggestions.classList.add('hidden');
            })
            .catch(error => {
                newClientModalErrorMessage.textContent = error.message;
                newClientModalError.classList.remove('hidden');
            });
        });

        // Initialize product list and other existing JS code below (unchanged)...

        const productList = document.querySelector('#product-list tbody');
        const addProductBtn = document.getElementById('add-product-btn');
        let currentRate = {{ current_rate }};

        // Remove default product row and store as template
        const defaultRow = productList.querySelector('tr.product-item');
        let productTemplate = null;
        if (defaultRow) {
            productTemplate = defaultRow.cloneNode(true);
            defaultRow.remove();
        }

        // Función para actualizar el precio en Bolívares
        function updatePriceVes(priceUsdInput) {
            const priceUsd = parseFloat(priceUsdInput.value) || 0;
            const priceVesDisplay = priceUsdInput.closest('tr.product-item').querySelector('.price-ves-display');
            const priceVes = (priceUsd * currentRate).toFixed(2);
            priceVesDisplay.textContent = priceVes;
        }

        // Función para inicializar los precios y el stock
        function initializeProductItem(productItem) {
            const selectElement = productItem.querySelector('.product-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const priceUsdInput = productItem.querySelector('.price-usd-input');
            const quantityInput = productItem.querySelector('.quantity-input');

            // Asignar el precio USD desde el atributo data-
            if (priceUsdInput) {
                priceUsdInput.value = selectedOption.dataset.priceUsd;
                updatePriceVes(priceUsdInput);
            } else {
                // This is for non-admin
                const priceUsd = selectedOption.dataset.priceUsd;
                const priceUsdDisplay = productItem.querySelector('.price-usd-display');
                const priceUsdHiddenInput = productItem.querySelector('.price-usd-hidden-for-submit');
                const priceVesDisplay = productItem.querySelector('.price-ves-display');

                if (priceUsdDisplay) priceUsdDisplay.textContent = parseFloat(priceUsd).toFixed(2);
                if (priceUsdHiddenInput) priceUsdHiddenInput.value = priceUsd;
                if (priceVesDisplay) priceVesDisplay.textContent = (parseFloat(priceUsd) * currentRate).toFixed(2);
            }

            // Configurar validación de cantidad según stock disponible
            if (quantityInput && selectedOption.dataset.stock) {
                const availableStock = parseInt(selectedOption.dataset.stock);
                quantityInput.max = availableStock;
                quantityInput.placeholder = `Máx: ${availableStock}`;

                // Validar cantidad actual si existe
                const currentQuantity = parseInt(quantityInput.value) || 0;
                if (currentQuantity > availableStock) {
                    quantityInput.value = availableStock;
                    showStockWarning(productItem, `Cantidad ajustada al stock disponible: ${availableStock}`);
                }
            }

            // Actualizar el stock en la etiqueta del producto
            const productName = selectedOption.text.split(' (')[0];
            selectedOption.text = `${productName} (Stock: ${selectedOption.dataset.stock})`;
        }

        // Función para mostrar advertencias de stock
        function showStockWarning(productItem, message) {
            // Remover advertencias anteriores
            const existingWarning = productItem.querySelector('.stock-warning');
            if (existingWarning) {
                existingWarning.remove();
            }

            // Crear nueva advertencia
            const warningDiv = document.createElement('div');
            warningDiv.className = 'stock-warning text-red-600 text-sm font-semibold mt-1';
            warningDiv.textContent = `⚠️ ${message}`;

            // Insertar después del select
            const selectElement = productItem.querySelector('.product-select');
            selectElement.parentNode.insertBefore(warningDiv, selectElement.nextSibling);

            // Remover advertencia después de 5 segundos
            setTimeout(() => {
                if (warningDiv.parentNode) {
                    warningDiv.remove();
                }
            }, 5000);
        }

        // Función para validar cantidad en tiempo real
        function validateQuantityInput(quantityInput) {
            const productItem = quantityInput.closest('tr.product-item');
            const selectElement = productItem.querySelector('.product-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];

            if (!selectedOption || !selectedOption.dataset.stock) return;

            const availableStock = parseInt(selectedOption.dataset.stock);
            const requestedQuantity = parseInt(quantityInput.value) || 0;

            // Remover clases de validación anteriores
            quantityInput.classList.remove('border-red-500', 'border-green-500');

            if (requestedQuantity > availableStock) {
                quantityInput.classList.add('border-red-500');
                showStockWarning(productItem, `Stock insuficiente. Disponible: ${availableStock}, Solicitado: ${requestedQuantity}`);
                // No permitir valores superiores al stock
                quantityInput.value = availableStock;
                updateOrderSummary();
            } else if (requestedQuantity > 0) {
                quantityInput.classList.add('border-green-500');
            }

            // Mostrar advertencia si el stock está bajo
            if (availableStock < 5 && requestedQuantity > 0) {
                showStockWarning(productItem, `¡Atención! Stock bajo (${availableStock} unidades disponibles)`);
            }
        }

        // Event listener para actualizar el precio en Bs al cambiar el producto
        productList.addEventListener('change', function(event) {
            if (event.target.classList.contains('product-select')) {
                initializeProductItem(event.target.closest('tr.product-item'));
            }
        });
        
        // Event listener para recalcular el precio en Bs cuando se edita el precio USD
        productList.addEventListener('input', function(event) {
            if (event.target.classList.contains('price-usd-input')) {
                updatePriceVes(event.target);
            }
        });

        // Inicializar el primer producto
        document.querySelectorAll('tr.product-item').forEach(initializeProductItem);

        // Event listener para agregar un nuevo producto
        addProductBtn.addEventListener('click', function() {
            const newProductItem = productTemplate.cloneNode(true);

            // Limpiar valores del nuevo clon
            newProductItem.querySelector('.product-select').selectedIndex = 0;
            newProductItem.querySelector('.quantity-input').value = '';
            {% if current_user.is_authenticated and current_user.role == 'administrador' %}
            const priceUsdInput = newProductItem.querySelector('.price-usd-input');
            if (priceUsdInput) {
                priceUsdInput.value = '';
            }
            {% endif %}

            // Habilitar el botón de eliminar
            const removeBtn = newProductItem.querySelector('.remove-product-btn');
            removeBtn.disabled = false;
            removeBtn.style.display = 'inline-block';

            // Inicializar el nuevo clon
            initializeProductItem(newProductItem);

            productList.appendChild(newProductItem);
        });

        // Event listener para eliminar una fila de producto
        productList.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-product-btn') || event.target.closest('.remove-product-btn')) {
                const productItem = event.target.closest('tr.product-item');
                if (productList.childElementCount > 1) {
                    productItem.remove();
                    updateOrderSummary();
                }
            }
        });

        // Función para actualizar el código del producto
        function updateProductCodeDisplay(productItem) {
            const selectElement = productItem.querySelector('.product-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const codigoDisplay = productItem.querySelector('.codigo-producto-display');
            const codigo = selectedOption.dataset.codigo || 'Sin código';
            codigoDisplay.textContent = `Código: ${codigo}`;
        }

        // Actualizar códigos de producto al inicializar
        document.querySelectorAll('tr.product-item').forEach(updateProductCodeDisplay);

        // Event listener para actualizar código al cambiar producto
        productList.addEventListener('change', function(event) {
            if (event.target.classList.contains('product-select')) {
                updateProductCodeDisplay(event.target.closest('tr.product-item'));
                updateOrderSummary();
            }
        });

        // Event listener para actualizar resumen al cambiar cantidad o precio
        productList.addEventListener('input', function(event) {
            if (event.target.classList.contains('quantity-input')) {
                // Validar cantidad contra stock disponible
                validateQuantityInput(event.target);
                updateOrderSummary();
            } else if (event.target.classList.contains('price-usd-input')) {
                updatePriceVes(event.target);
                updateOrderSummary();
            }
        });

        // Función para calcular y actualizar el resumen de la orden
        function updateOrderSummary() {
            let subtotal = 0;
            
            document.querySelectorAll('tr.product-item').forEach(productItem => {
                const quantity = parseFloat(productItem.querySelector('.quantity-input').value) || 0;
                const priceUsdInput = productItem.querySelector('.price-usd-input');
                let priceUsd = 0;
                if (priceUsdInput) {
                    priceUsd = parseFloat(priceUsdInput.value) || 0;
                } else {
                    // For non-admin users, use the default price from the selected option
                    const selectElement = productItem.querySelector('.product-select');
                    const selectedOption = selectElement.options[selectElement.selectedIndex];
                    priceUsd = parseFloat(selectedOption.dataset.priceUsd) || 0;
                }
                const priceVes = priceUsd * currentRate;
                
                subtotal += quantity * priceVes;
            });

            const iva = 0; // IVA desactivado
            const total = subtotal;

            document.getElementById('subtotal-display').textContent = subtotal.toFixed(2) + ' Bs';
            document.getElementById('iva-display').textContent = iva.toFixed(2) + ' Bs';
            document.getElementById('total-display').textContent = total.toFixed(2) + ' Bs';
        }

        // Inicializar resumen de la orden
        updateOrderSummary();

        // Función para agregar producto por código de barras
        document.getElementById('scan-barcode-btn').addEventListener('click', function() {
            const barcode = document.getElementById('barcode-input').value.trim();
            if (!barcode) {
                alert('Por favor ingrese un código de barras');
                return;
            }

            fetch(`/api/product_by_barcode/${barcode}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Producto no encontrado');
                    }
                    return response.json();
                })
                .then(product => {
                    // Verificar si el producto tiene stock disponible
                    if (product.stock <= 0) {
                        alert(`⚠️ Producto "${product.name}" agotado. Stock disponible: ${product.stock}`);
                        document.getElementById('barcode-input').focus();
                        return;
                    }

                    // Verificar si el producto ya existe en la lista
                    let existingProductItem = null;
                    document.querySelectorAll('tr.product-item').forEach(item => {
                        const selectElement = item.querySelector('.product-select');
                        if (selectElement.value == product.id) {
                            existingProductItem = item;
                        }
                    });

                    if (existingProductItem) {
                        // Si el producto ya existe, incrementar la cantidad
                        const quantityInput = existingProductItem.querySelector('.quantity-input');
                        const currentQuantity = parseInt(quantityInput.value) || 0;
                        const newQuantity = currentQuantity + 1;

                        // Verificar que no exceda el stock disponible
                        if (newQuantity > product.stock) {
                            alert(`⚠️ No se puede agregar más unidades. Stock disponible: ${product.stock}, Cantidad actual: ${currentQuantity}`);
                            document.getElementById('barcode-input').focus();
                            return;
                        }

                        quantityInput.value = newQuantity;

                        // Validar la cantidad y actualizar resumen
                        validateQuantityInput(quantityInput);
                        updateOrderSummary();
                    } else {
                        // Si no existe, crear nueva fila de producto
                        const newProductItem = productTemplate.cloneNode(true);

                        // Seleccionar el producto en el dropdown
                        const selectElement = newProductItem.querySelector('.product-select');
                        for (let i = 0; i < selectElement.options.length; i++) {
                            if (selectElement.options[i].value == product.id) {
                                selectElement.selectedIndex = i;
                                break;
                            }
                        }

                        // Habilitar botón de eliminar
                        const removeBtn = newProductItem.querySelector('.remove-product-btn');
                        removeBtn.disabled = false;
                        removeBtn.style.display = 'inline-block';

                        // Inicializar el nuevo producto
                        initializeProductItem(newProductItem);
                        updateProductCodeDisplay(newProductItem);

                        // Establecer cantidad predeterminada a 1
                        newProductItem.querySelector('.quantity-input').value = '1';

                        // Agregar a la lista
                        productList.appendChild(newProductItem);

                        // Actualizar resumen
                        updateOrderSummary();
                    }

                    // Limpiar input de código de barras y devolver el cursor
                    document.getElementById('barcode-input').value = '';
                    document.getElementById('barcode-input').focus();
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                    document.getElementById('barcode-input').focus();
                });
        });

        // Permitir agregar producto con Enter en el input de código de barras
        document.getElementById('barcode-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('scan-barcode-btn').click();
            }
        });

        // --- Lógica del Modal de Pago ---
        const paymentModal = document.getElementById('payment-modal');
        const processPaymentBtn = document.getElementById('process-payment-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const finalizeOrderBtn = document.getElementById('finalize-order-btn');
        const addPaymentBtnModal = document.getElementById('add-payment-btn-modal');

        const modalTotalAmount = document.getElementById('modal-total-amount');
        const modalPaidAmount = document.getElementById('modal-paid-amount');
        const modalRemainingAmount = document.getElementById('modal-remaining-amount');
        const modalChangeDisplay = document.getElementById('modal-change-display');
        const modalChangeAmount = document.getElementById('modal-change-amount');
        
        const paymentMethodSelect = document.getElementById('payment-method');
        const paymentAmountInput = document.getElementById('payment-amount');
        const paymentReferenceGroup = document.getElementById('payment-reference-group');
        const paymentReferenceInput = document.getElementById('payment-reference');
        const paymentBankGroup = document.getElementById('payment-bank-group');
        const paymentBankSelect = document.getElementById('payment-bank');
        const paymentPosGroup = document.getElementById('payment-pos-group');
        const paymentPosSelect = document.getElementById('payment-pos');
        const paymentCashboxGroup = document.getElementById('payment-cashbox-group');
        const paymentCashboxSelect = document.getElementById('payment-cashbox');

        const paymentsListDiv = document.getElementById('payments-list');
        const paymentsDataInput = document.getElementById('payments-data-input');

        let payments = [];
        let orderTotal = 0;

        function updatePaymentAmountInput() {
            const totalPaid = payments.reduce((sum, p) => sum + p.amount_ves_equivalent, 0);
            let remaining = orderTotal - totalPaid;

            if (remaining <= 0.01) {
                paymentAmountInput.value = '';
                return;
            }

            const method = paymentMethodSelect.value;

            if (method === 'efectivo_usd') {
                if (currentRate > 0) {
                    const amountUsd = remaining / currentRate;
                    paymentAmountInput.value = amountUsd.toFixed(2);
                } else {
                    paymentAmountInput.value = '0.00'; // Avoid division by zero
                }
            } else {
                paymentAmountInput.value = remaining.toFixed(2);
            }
        }

        function openPaymentModal() {
            updateOrderSummary(); // Asegurarse de que el total está actualizado
            orderTotal = parseFloat(document.getElementById('total-display').textContent) || 0;
            
            if (orderTotal <= 0) {
                alert("Agregue productos a la orden antes de procesar el pago.");
                return;
            }

            modalTotalAmount.textContent = orderTotal.toFixed(2) + ' Bs';
            updatePaymentSummary(); // This will set up the initial state of the modal correctly
            paymentModal.classList.remove('hidden');
        }

        function closePaymentModal() {
            paymentModal.classList.add('hidden');
            payments = []; // Limpiar pagos si se cierra el modal
            paymentsListDiv.innerHTML = '';
            modalChangeDisplay.classList.add('hidden');
        }

        function updatePaymentSummary() {
            const totalPaid = payments.reduce((sum, p) => sum + p.amount_ves_equivalent, 0);
            const remaining = orderTotal - totalPaid;

            modalPaidAmount.textContent = totalPaid.toFixed(2) + ' Bs';

            // Handle change display
            if (remaining < -0.001) { // Overpaid, show change
                const change = Math.abs(remaining);
                const changeInBs = change.toFixed(2);
                const changeInUsd = (change / currentRate).toFixed(2);
                modalChangeAmount.textContent = `Bs ${changeInBs} / $${changeInUsd}`;
                modalChangeDisplay.classList.remove('hidden');
            } else {
                modalChangeDisplay.classList.add('hidden');
            }

            // Handle remaining amount display and input field
            if (remaining > 0.01) { // Amount is still pending
                modalRemainingAmount.textContent = remaining.toFixed(2) + ' Bs';
                modalRemainingAmount.classList.remove('text-green-600');
                modalRemainingAmount.classList.add('text-red-600');
                finalizeOrderBtn.disabled = true;
            } else { // Paid in full or overpaid
                modalRemainingAmount.textContent = '0.00 Bs';
                modalRemainingAmount.classList.remove('text-red-600');
                modalRemainingAmount.classList.add('text-green-600');
                finalizeOrderBtn.disabled = false;
            }
            updatePaymentAmountInput();
        }

        function addPayment() {
            const method = paymentMethodSelect.value;
            const amount = parseFloat(paymentAmountInput.value);
            const reference = paymentReferenceInput.value;
            const bank_id = paymentBankSelect.value;
            const pos_id = paymentPosSelect.value;
            const cash_box_id = paymentCashboxSelect.value;

            if (!amount || amount <= 0) {
                alert("Por favor, ingrese un monto válido.");
                return;
            }

            // Validar selección de destino
            if (method === 'transferencia' && !bank_id) {
                alert("Por favor, seleccione un banco de destino.");
                return;
            }
            if (method === 'punto_de_venta' && !pos_id) {
                alert("Por favor, seleccione un punto de venta.");
                return;
            }
            if (method.startsWith('efectivo') && !cash_box_id) {
                alert("Por favor, seleccione una caja.");
                return;
            }

            let amount_ves_equivalent = amount;
            let currency_paid = 'VES';

            if (method === 'efectivo_usd') {
                amount_ves_equivalent = amount * currentRate;
                currency_paid = 'USD';
            }

            const payment = {
                method: method,
                amount_paid: amount,
                currency_paid: currency_paid,
                amount_ves_equivalent: amount_ves_equivalent,
                reference: reference,
                bank_id: method === 'transferencia' ? parseInt(bank_id) : null,
                pos_id: method === 'punto_de_venta' ? parseInt(pos_id) : null,
                cash_box_id: method.startsWith('efectivo') ? parseInt(cash_box_id) : null,
            };

            payments.push(payment);
            renderPayments();
            updatePaymentSummary();

            // Limpiar formulario de pago
            paymentAmountInput.value = '';
            paymentReferenceInput.value = '';
            paymentBankSelect.selectedIndex = 0;
            paymentPosSelect.selectedIndex = 0;
            paymentCashboxSelect.selectedIndex = 0;
        }

        function renderPayments() {
            paymentsListDiv.innerHTML = '';
            payments.forEach((p, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                let details = `${p.method.replace(/_/g, ' ')}: ${p.amount_paid.toFixed(2)} ${p.currency_paid} (Equiv. ${p.amount_ves_equivalent.toFixed(2)} Bs)`;
                if (p.reference) {
                    details += ` - Ref: ${p.reference}`;
                }
                div.innerHTML = `
                    <span>${details}</span>
                    <button type="button" data-index="${index}" class="remove-payment-btn text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                `;
                paymentsListDiv.appendChild(div);
            });
        }

        processPaymentBtn.addEventListener('click', openPaymentModal);
        closeModalBtn.addEventListener('click', closePaymentModal);
        addPaymentBtnModal.addEventListener('click', addPayment);

        paymentMethodSelect.addEventListener('change', function() {
            const method = this.value;
            paymentReferenceGroup.classList.toggle('hidden', method !== 'transferencia');
            paymentBankGroup.classList.toggle('hidden', method !== 'transferencia');
            paymentPosGroup.classList.toggle('hidden', method !== 'punto_de_venta');
            paymentCashboxGroup.classList.toggle('hidden', !method.startsWith('efectivo'));
            updatePaymentAmountInput();
        });

        paymentsListDiv.addEventListener('click', function(e) {
            if (e.target.closest('.remove-payment-btn')) {
                const index = e.target.closest('.remove-payment-btn').dataset.index;
                payments.splice(index, 1);
                renderPayments();
                updatePaymentSummary();
            }
        });

        finalizeOrderBtn.addEventListener('click', function() {
            paymentsDataInput.value = JSON.stringify(payments);
            document.getElementById('order-form').submit();
        });

        // Disparar el evento change al cargar para establecer el estado inicial correcto
        paymentMethodSelect.dispatchEvent(new Event('change'));
    });
</script>
{% endblock %}
