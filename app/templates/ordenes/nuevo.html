{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4 max-w-4xl">
    <div class="flex items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-cart-plus mr-2"></i>Crear Nueva Orden de Venta</h1>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
        <form method="POST" action="{{ url_for('new_order') }}">
            <!-- Información de la orden -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Información de la Orden</h2>
                <label for="client_id" class="block text-gray-700 font-bold mb-2">Cliente:</label>
                <select id="client_id" name="client_id" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    {% for client in clients %}
                        <option value="{{ client.id }}">{{ client.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Lista de productos -->
            <div id="product-list" class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Productos</h2>
                <div class="space-y-4">
                    <!-- Fila de ejemplo para clonar -->
                    <div class="product-item flex items-center space-x-4 border p-4 rounded-lg bg-gray-50">
                        <select name="product_id[]" required class="flex-1 shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 product-select">
                            {% for product in products %}
                                <option value="{{ product.id }}" data-price-usd="{{ product.price_usd }}" data-stock="{{ product.stock }}">{{ product.name }} (Stock: {{ product.stock }})</option>
                            {% endfor %}
                        </select>
                        <input type="number" name="quantity[]" placeholder="Cantidad" min="1" required class="w-24 shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 quantity-input">
                        
                        <div class="flex flex-col">
                            <label class="text-sm text-gray-500">USD</label>
                            <input type="number" name="price_usd[]" placeholder="Precio USD" step="0.01" min="0" required class="w-24 shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 price-usd-input">
                        </div>
                        <div class="flex flex-col">
                            <label class="text-sm text-gray-500">Bs</label>
                            <span class="price-ves-display w-24 text-center font-bold text-gray-800">0.00</span>
                        </div>
                        
                        <button type="button" class="bg-red-500 text-white p-2 rounded remove-product-btn hover:bg-red-600 transition-colors"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="mt-4">
                    <button type="button" id="add-product-btn" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Agregar Otro Producto
                    </button>
                </div>
            </div>

            <div class="flex items-center justify-end">
                <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">
                    <i class="fas fa-save mr-2"></i>Crear Orden
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const productList = document.querySelector('#product-list .space-y-4');
        const addProductBtn = document.getElementById('add-product-btn');
        let currentRate = {{ current_rate }};

        // Función para actualizar el precio en Bolívares
        function updatePriceVes(priceUsdInput) {
            const priceUsd = parseFloat(priceUsdInput.value) || 0;
            const priceVesDisplay = priceUsdInput.closest('.product-item').querySelector('.price-ves-display');
            const priceVes = (priceUsd * currentRate).toFixed(2);
            priceVesDisplay.textContent = priceVes;
        }

        // Función para inicializar los precios y el stock
        function initializeProductItem(productItem) {
            const selectElement = productItem.querySelector('.product-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const priceUsdInput = productItem.querySelector('.price-usd-input');
            
            // Asignar el precio USD desde el atributo data-
            priceUsdInput.value = selectedOption.dataset.priceUsd;
            updatePriceVes(priceUsdInput);
            
            // Actualizar el stock en la etiqueta del producto
            const productName = selectedOption.text.split(' (')[0];
            selectedOption.text = `${productName} (Stock: ${selectedOption.dataset.stock})`;
        }

        // Event listener para actualizar el precio en Bs al cambiar el producto
        productList.addEventListener('change', function(event) {
            if (event.target.classList.contains('product-select')) {
                initializeProductItem(event.target.closest('.product-item'));
            }
        });
        
        // Event listener para recalcular el precio en Bs cuando se edita el precio USD
        productList.addEventListener('input', function(event) {
            if (event.target.classList.contains('price-usd-input')) {
                updatePriceVes(event.target);
            }
        });

        // Inicializar el primer producto
        document.querySelectorAll('.product-item').forEach(initializeProductItem);

        // Event listener para agregar un nuevo producto
        addProductBtn.addEventListener('click', function() {
            const firstProductItem = productList.querySelector('.product-item');
            const newProductItem = firstProductItem.cloneNode(true);
            
            // Limpiar valores del nuevo clon
            newProductItem.querySelector('.product-select').selectedIndex = 0;
            newProductItem.querySelector('.quantity-input').value = '';
            newProductItem.querySelector('.price-usd-input').value = '';

            // Habilitar el botón de eliminar
            const removeBtn = newProductItem.querySelector('.remove-product-btn');
            removeBtn.disabled = false;
            removeBtn.style.display = 'inline-block';

            // Inicializar el nuevo clon
            initializeProductItem(newProductItem);
            
            productList.appendChild(newProductItem);
        });

        // Event listener para eliminar una fila de producto
        productList.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-product-btn') || event.target.closest('.remove-product-btn')) {
                const productItem = event.target.closest('.product-item');
                if (productList.childElementCount > 1) {
                    productItem.remove();
                }
            }
        });
    });
</script>
{% endblock %}