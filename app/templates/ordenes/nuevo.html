{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-2 max-w-7xl">
    <div class="bg-white p-4 rounded-lg shadow-md">
        <form method="POST" action="{{ url_for('main.new_order') }}" id="order-form">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-bold text-gray-800"><i class="fas fa-cart-plus m-1"></i>Crear Nueva Orden de Venta</h1>
                <div>
                    <label for="date_created" class="block text-gray-700 font-bold mb-1 text-sm">Fecha y Hora de la Orden:</label>
                    <input type="datetime-local" id="date_created" name="date_created" value="{{ current_ve_time.strftime('%Y-%m-%dT%H:%M') }}" class="shadow appearance-none border rounded py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <!-- Main two-column layout -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-4">
                <!-- LEFT COLUMN: Client and Actions -->
                <div class="space-y-4 lg:col-span-1">
                    <!-- Client Info (Accessible to Vendedor and above) -->
                    <div>
                        <h2 class="text-lg font-semibold text-gray-700 mb-2">1. Información del Cliente</h2>
                        <div class="space-y-2">
                            <input type="text" id="client_search" name="client_search" autocomplete="off" placeholder="Cédula, RIF o Nombre..." class="shadow-sm appearance-none border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" required>
                            <input type="hidden" id="client_id" name="client_id" required>
                            <div id="client_suggestions" class="border border-gray-300 rounded mt-1 max-h-32 overflow-y-auto bg-white hidden"></div>
                            <div id="client_info" class="mt-2 p-2 border border-gray-200 rounded bg-gray-50 hidden text-sm">
                                <div class="font-semibold mb-1">Cliente Seleccionado:</div>
                                <div><strong>Nombre:</strong> <span id="client_name"></span></div>
                                <div><strong>Cédula/RIF:</strong> <span id="client_cedula_rif"></span></div>
                                <div><strong>Teléfono:</strong> <span id="client_phone"></span></div>
                                <div><strong>Email:</strong> <span id="client_email"></span></div>
                                <div><strong>Dirección:</strong> <span id="client_address"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Tipo de Venta -->
                    <div>
                        <label for="sale_type" class="block text-gray-700 font-bold mb-1 text-sm">Tipo de Venta</label>
                        <select id="sale_type" name="sale_type" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                            <option value="regular">Venta Regular</option>
                            <option value="credit">Venta a Crédito</option>
                            <option value="reservation">Apartado</option>
                            <option value="special_dispatch">Entrega Especial</option>
                        </select>
                    </div>

                    {% if is_gerente() %} {# Only Superuser and Gerente can set special exchange rate #}
                    <div class="mt-4">
                        <label for="special_exchange_rate" class="block text-gray-700 font-bold mb-1 text-sm">Tasa de Cambio Especial (USD a Bs):</label>
                        <input type="number" step="0.01" id="special_exchange_rate" name="special_exchange_rate" placeholder="Dejar vacío para usar la tasa actual"
                               class="shadow appearance-none border rounded py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        <p class="text-xs text-gray-500 mt-1">Solo para administradores. Anula la tasa actual para esta orden.</p>
                    </div>
                    {% endif %}

                    
                </div>

                <!-- RIGHT COLUMN: Product List -->
                <div class="lg:col-span-3">
                    <!-- Barcode Scanner & Add Product -->
                    <div class="mb-2">
                        <h2 class="text-lg font-semibold text-gray-700 mb-2">2. Añadir Productos</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                            <div>
                                <label for="barcode-input" class="block text-sm font-medium text-gray-700">Escanear Código de Barras</label>
                                <input type="text" id="barcode-input" placeholder="Escanear para agregar..." class="mt-1 w-full shadow-sm appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="relative">
                                <label for="product-keyword-search" class="block text-sm font-medium text-gray-700">Buscar por Nombre / Código</label>
                                <input type="text" id="product-keyword-search" placeholder="Escribir para buscar..." class="mt-1 w-full shadow-sm appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <div id="product-suggestions-sale" class="absolute bg-white border rounded-b-lg mt-1 w-full z-20 hidden max-h-60 overflow-y-auto"></div>
                            </div>
                        </div>
                        <div class="flex justify-end">
                             <button type="button" id="add-product-btn" class="bg-gray-500 text-white py-1 px-3 rounded hover:bg-gray-600 transition-colors text-sm whitespace-nowrap">
                                <i class="fas fa-plus mr-1"></i>Agregar Manual
                            </button>
                        </div>
                    </div>
                    <div id="product-list" class="max-h-[55vh] overflow-y-auto border rounded-lg">
                        <table class="table-auto w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th rowspan="2" class="px-1 py-1 text-left font-semibold align-middle">Producto</th>
                                    <th rowspan="2" class="px-1 py-1 text-center font-semibold align-middle">Cant.</th>
                                    <th colspan="2" class="px-1 py-1 text-center font-semibold">Precio Unitario</th>
                                    <th rowspan="2" class="px-1 py-1 text-center font-semibold align-middle">Total</th>
                                    <th rowspan="2" class="px-1 py-1 text-center font-semibold align-middle"></th>
                                </tr>
                                <tr>
                                    <th class="px-1 py-1 text-center font-semibold bg-gray-100">{{ currency_symbol }}</th>
                                    <th class="px-1 py-1 text-center font-semibold bg-gray-100">Bs</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <!-- Fila de ejemplo para clonar -->
                                <tr class="product-item bg-gray-50">
                                    <td class="px-1 py-1 align-top">
                                        <select name="product_id[]" required class="w-full shadow-sm appearance-none border rounded py-0.5 px-1 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 product-select text-xs">
                                    {% for product in products %}
                                        {% if product.stock_tienda > 0 %} {# Producto disponible para la venta desde la tienda principal #} 
                                            <option value="{{ product.id }}" data-price-usd="{{ product.price_usd }}" data-stock="{{ product.stock_tienda }}" data-codigo="{{ product.codigo_producto }}"
                                                    class="{% if product.stock_tienda < 5 %}stock-low{% elif product.stock_tienda < 20 %}stock-medium{% else %}stock-high{% endif %}">
                                                {{ product.barcode }} | {{ product.name }}
                                            </option>
                                        {% else %} {# Producto agotado, se muestra pero no se puede seleccionar #} 
                                            <option value="{{ product.id }}" disabled data-price-usd="{{ product.price_usd }}" data-stock="{{ product.stock_tienda }}" data-codigo="{{ product.codigo_producto }}" class="stock-out">
                                                {{ product.name }} (AGOTADO EN TIENDA - Stock: {{ product.stock_tienda }})
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                        </select>
                                        <div class="text-xs text-gray-500 mt-1 codigo-producto-display"></div>
                                    </td>
                                    <td class="px-1 py-1 align-top">
                                        <input type="number" name="quantity[]" placeholder="Cant." min="1" required class="w-16 shadow-sm appearance-none border rounded py-0.5 px-1 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 quantity-input text-sm text-center">
                                    </td>
                                    <td class="px-1 py-1 align-top">
                                {% if is_gerente() %} {# Only Superuser and Gerente can edit price_usd #}
                                        <input type="number" name="price_usd[]" placeholder="Precio" step="0.01" min="0" required class="w-20 shadow-sm appearance-none border rounded py-0.5 px-1 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 price-usd-input text-sm text-center">
                                {% else %}
                                        <span class="w-20 text-center font-bold text-gray-800 price-usd-display text-sm">0.00</span>
                                        <input type="hidden" name="price_usd[]" class="price-usd-hidden-for-submit">
                                {% endif %}
                                    </td>
                                    <td class="px-1 py-1 text-center font-bold text-gray-600 price-ves-display text-sm align-top">0.00</td>
                                    <td class="px-1 py-1 text-center font-bold text-gray-800 row-total-display text-sm align-top">0.00</td>
                                    <td class="px-1 py-1 text-center align-top">
                                        <button type="button" class="bg-red-500 text-white py-0.5 px-2 rounded remove-product-btn hover:bg-red-600 transition-colors"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- BOTTOM SECTION: Summary and Actions -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 border-t pt-4 mt-2">
                <!-- Resumen y Botón para procesar el pago -->
                <div class="space-y-3 lg:col-start-2 lg:col-span-3">
                    <!-- Financial Summary Section (hidden for special dispatch) -->
                    <div id="financial-summary-section">
                        <!-- Resumen de la orden -->
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 max-w-sm ml-auto text-sm">
                            <div class="text-right font-semibold">Subtotal:</div>
                            <div class="text-right" id="subtotal-display">0.00 Bs</div>
    
                            <div class="text-right font-semibold flex items-center justify-end">
                                <input type="checkbox" id="discount-enabled-checkbox" name="discount_enabled" value="on" class="h-4 w-4 mr-2 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="discount-enabled-checkbox">Descuento ({{ currency_symbol }}):</label>
                            </div>
                            <div class="text-right">
                                <input type="number" id="discount-input" name="discount_usd" value="0.00" step="0.01" min="0" class="w-24 shadow-sm appearance-none border rounded py-0.5 px-1 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 text-right text-sm disabled:bg-gray-200 disabled:cursor-not-allowed" disabled>
                            </div>
    
                            <div class="text-right font-semibold hidden">IVA:</div>
                            <div class="text-right hidden" id="iva-display">0.00 Bs</div>
    
                            <div class="text-right font-bold text-lg border-t pt-1 col-span-1">Total a Pagar:</div>
                            <div class="text-right font-bold text-lg border-t pt-1 col-span-1" id="total-display">0.00 Bs</div>
                        </div>
                    </div>

                    <!-- Special Dispatch Reason Section (hidden by default) -->
                    <div id="special-dispatch-reason-section" class="hidden">
                        <label for="dispatch_reason" class="block text-gray-700 font-bold mb-1">Motivo de la Entrega Especial (Obligatorio):</label>
                        <textarea id="dispatch_reason" name="dispatch_reason" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Mercancía para exhibición, donación, uso interno, etc."></textarea>
                    </div>

                    <!-- Botones de acción -->
                    <div class="flex justify-between items-center mt-2">
                        <div>
                            {% if last_order %}
                            <a href="{{ url_for('main.print_delivery_note', order_id=last_order.id) }}" target="_blank" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg focus:outline-none focus:shadow-outline text-sm">
                                <i class="fas fa-print mr-2"></i>Reimprimir Última Orden (#{{ last_order.id|order_id_format }})
                            </a>
                            {% endif %}
                        </div>
                        <div>
                            <input type="hidden" name="payments_data" id="payments-data-input">
                            <button type="button" id="main-action-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-all">
                                <i class="fas fa-dollar-sign mr-2"></i>Procesar Pago y Crear Orden
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Payment Modal -->
<div id="payment-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-4 border w-full max-w-5xl shadow-lg rounded-md bg-white">
        <div class="mt-1">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl leading-6 font-medium text-gray-900">Registrar Pago</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
                <!-- Columna Izquierda para Alertas y Resumen -->
                <div class="lg:col-span-2 space-y-3">
                    <div id="credit-sale-notice" class="hidden bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-3 rounded text-sm" role="alert">
                        <p class="font-bold">Venta a Crédito</p>
                        <p>Puede registrar un abono inicial o finalizar la orden sin pagos. El saldo pendiente se registrará en la cuenta del cliente.</p> 
                    </div>
                    <div id="payment-restriction-message" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 rounded text-sm" role="alert">
                        <p class="font-bold">Atención</p>
                        <p>Debido al descuento aplicado, solo se permite el pago en Efectivo (USD).</p>
                    </div>
                    <!-- Resumen de Pago -->
                    <div class="bg-blue-50 p-3 rounded-lg text-center">
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <p class="text-xs text-gray-600">Total a Pagar</p>
                                <p id="modal-total-amount" class="text-lg font-bold text-blue-800">0.00 Bs</p>
                                <p id="modal-total-amount-usd" class="text-sm font-semibold text-blue-700">0.00 {{ currency_symbol }}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Total Pagado</p>
                                <p id="modal-paid-amount" class="text-lg font-bold text-green-600">0.00 Bs</p>
                                <p id="modal-paid-amount-usd" class="text-sm font-semibold text-green-500">0.00 {{ currency_symbol }}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Monto Restante</p>
                                <p id="modal-remaining-amount" class="text-lg font-bold text-red-600">0.00 Bs</p>
                                <p id="modal-remaining-amount-usd" class="text-sm font-semibold text-red-500">0.00 {{ currency_symbol }}</p>
                            </div>
                        </div>
                        <!-- Vuelto Display -->
                        <div id="modal-change-display" class="mt-2 hidden text-center">
                            <p class="text-sm text-gray-700">Vuelto a entregar:</p>
                            <p id="modal-change-amount" class="text-xl font-bold text-yellow-600">0.00</p>
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha para Formularios y Lista -->
                <div class="lg:col-span-3">
                    <!-- Formulario para agregar pago -->
                    <div id="add-payment-form" class="border p-3 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                            <div>
                                <label for="payment-method" class="block text-sm font-medium text-gray-700">Método de Pago</label>
                                <select id="payment-method" class="mt-1 block w-full py-1 px-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="efectivo_ves">Efectivo (Bs)</option>
                                    <option value="efectivo_usd">Efectivo (USD)</option>
                                    <option value="transferencia">Transferencia/Pago Móvil</option>
                                    <option value="punto_de_venta">Punto de Venta</option>
                                </select>
                            </div>
                            <div>
                                <label for="payment-amount" class="block text-sm font-medium text-gray-700">Monto</label>
                                <input type="number" id="payment-amount" step="0.01" min="0.01" class="mt-1 block w-full py-1 px-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div class="md:col-span-1">
                                <button type="button" id="add-payment-btn-modal" class="w-full bg-blue-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-blue-600">
                                    <i class="fas fa-plus mr-1"></i>Agregar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Campo de moneda para transferencia -->
                        <div id="payment-currency-group" class="hidden">
                            <label for="payment-currency" class="block text-sm font-medium text-gray-700">Moneda de Transferencia</label>
                            <select id="payment-currency" class="mt-1 block w-full py-1 px-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <option value="VES">Bolívares (VES)</option>
                                <option value="USD">Dólares (USD)</option>
                            </select>
                        </div>

                        <!-- Campos condicionales -->
                        <div id="payment-details-group" class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
                            <div id="payment-reference-group" class="hidden">
                                <label for="payment-reference" class="block text-sm font-medium text-gray-700">Referencia</label>
                                <input type="text" id="payment-reference" class="mt-1 block w-full py-1 px-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div id="payment-issuing-bank-group" class="hidden">
                                <label for="payment-issuing-bank" class="block text-sm font-medium text-gray-700">Banco Origen</label>
                                <select id="payment-issuing-bank" class="mt-1 block w-full py-1 px-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="">Seleccione un banco</option>
                                    <option value="Banco de Venezuela">Banco de Venezuela</option>
                                    <option value="BBVA Provincial">BBVA Provincial</option>
                                    <option value="Banesco">Banesco</option>
                                    <option value="Banesco Panama">Banesco Panamá</option>
                                    <option value="Binance">Binance</option>
                                    <option value="BNC (Banco Nacional de Crédito)">BNC (Banco Nacional de Crédito)</option>
                                    <option value="Mercantil">Mercantil</option>
                                    <option value="Mercantil Panama">Mercantil Panamá</option>
                                    <option value="Bancamiga">Bancamiga</option>
                                    <option value="BDT (Banco del Tesoro)">BDT (Banco del Tesoro)</option>
                                    <option value="Banplus">Banplus</option>
                                    <option value="Plaza">Plaza</option>
                                    <option value="Bancaribe">Bancaribe</option>
                                    <option value="Banco Exterior">Banco Exterior</option>
                                    <option value="Banco Caroní">Banco Caroní</option>
                                    <option value="Banco Activo">Banco Activo</option>
                                    <option value="Fondo Común (BFC)">Fondo Común (BFC)</option>
                                    <option value="Bancrecer">Bancrecer</option>
                                    <option value="Banco Del Sur">Banco Del Sur</option>
                                    <option value="ZELLE">ZELLE</option>
                                </select>
                            </div>
                            <div id="payment-sender-id-group" class="hidden">
                                <label for="payment-sender-id" class="block text-sm font-medium text-gray-700">Teléfono/C.I./Email</label>
                                <input type="text" id="payment-sender-id" class="mt-1 block w-full py-1 px-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div id="payment-bank-group" class="hidden">
                                <label for="payment-bank" class="block text-sm font-medium text-gray-700">Banco Destino</label>
                                <select id="payment-bank" class="mt-1 block w-full py-1 px-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="">Seleccione un banco</option>
                                    {% for bank in banks %}<option value="{{ bank.id }}" data-currency="{{ bank.currency }}">{{ bank.name }} ({{ bank.currency }})</option>{% endfor %}
                                </select>
                            </div>
                            <div id="payment-pos-group" class="hidden">
                                <label for="payment-pos" class="block text-sm font-medium text-gray-700">Punto de Venta</label>
                                <select id="payment-pos" class="mt-1 block w-full py-1 px-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="">Seleccione un POS</option>
                                    {% for pos in points_of_sale %}<option value="{{ pos.id }}">{{ pos.name }}</option>{% endfor %}
                                </select>
                            </div>
                            <div id="payment-cashbox-group" class="hidden">
                                <label for="payment-cashbox" class="block text-sm font-medium text-gray-700">Caja</label>
                                <select id="payment-cashbox" class="mt-1 block w-full py-1 px-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="">Seleccione una caja</option>
                                    {% for box in cash_boxes %}<option value="{{ box.id }}">{{ box.name }}</option>{% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de pagos agregados -->
                    <div class="mt-3">
                        <h4 class="text-base font-medium text-gray-800 mb-1">Pagos Registrados</h4>
                        <div id="payments-list" class="space-y-1 max-h-40 overflow-y-auto">
                            <!-- Los pagos se agregarán aquí dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botón de Finalizar -->
            <div class="mt-4 flex justify-end">
                <button type="button" id="finalize-order-btn" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition-all" disabled>
                    <i class="fas fa-check-circle mr-2"></i>Finalizar y Crear Orden
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Tasa de Cambio Temporal -->
{% if is_gerente() %} {# Only Superuser and Gerente can see this modal #}
<div id="rate-change-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                <i class="fas fa-exclamation-triangle text-2xl text-yellow-600"></i>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Cambio de Tasa de Cambio</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">
                    Ha seleccionado una fecha pasada. Para asegurar la consistencia de los cálculos, puede establecer una tasa de cambio temporal para esta orden.
                    La tasa actual (Bs. {{ '%.2f'|format(current_rate) }}) se restaurará automáticamente después de crear la orden.
                </p>
                <div class="mt-4">
                    <label for="modal_exchange_rate" class="block text-sm font-medium text-gray-700 text-left">Nueva Tasa para {{ calculation_currency }}:</label>
                    <input type="number" id="modal_exchange_rate" name="modal_exchange_rate" step="0.01" placeholder="{{ '%.2f'|format(current_rate) }}"
                           class="mt-1 w-full shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="items-center px-4 py-3">
                <button id="cancel-rate-change-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 mr-2">
                    Cancelar
                </button>
                <button id="update-rate-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                    <i class="fas fa-sync-alt mr-2"></i>Actualizar Tasa y Recargar
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- New Client Modal -->
<div id="new-client-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl leading-6 font-medium text-gray-900">Crear Nuevo Cliente</h3>
                <button id="close-new-client-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="new-client-modal-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden" role="alert">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline" id="new-client-modal-error-message"></span>
            </div>
            <form id="new-client-form">
                <div class="space-y-4">
                    <div>
                        <label for="new-client-name" class="block text-sm font-medium text-gray-700">Nombre Completo o Razón Social</label>
                        <input type="text" id="new-client-name" name="name" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new-client-cedula-rif" class="block text-sm font-medium text-gray-700">Cédula o RIF</label>
                        <input type="text" id="new-client-cedula-rif" name="cedula_rif" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new-client-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="new-client-email" name="email" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new-client-phone" class="block text-sm font-medium text-gray-700">Teléfono</label>
                        <input type="tel" id="new-client-phone" name="phone" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new-client-address" class="block text-sm font-medium text-gray-700">Dirección</label>
                        <textarea id="new-client-address" name="address" rows="2" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                    </div>
                </div>
                <div class="mt-8 flex justify-end">
                    <button type="button" id="cancel-new-client-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 mr-4">Cancelar</button>
                    <button type="button" id="save-new-client-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i>Guardar Cliente</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const BANK_ICONS = {{ BANK_ICONS|tojson|safe }};
    document.addEventListener('DOMContentLoaded', function() {
        const clientSearchInput = document.getElementById('client_search');
        const clientSuggestions = document.getElementById('client_suggestions');
        const clientIdInput = document.getElementById('client_id');
        const clientInfoDiv = document.getElementById('client_info');
        const clientNameSpan = document.getElementById('client_name');
        const clientCedulaRifSpan = document.getElementById('client_cedula_rif');
        const clientEmailSpan = document.getElementById('client_email');
        const clientPhoneSpan = document.getElementById('client_phone');
        const clientAddressSpan = document.getElementById('client_address');

        const keywordSearchInput = document.getElementById('product-keyword-search');
        const productSuggestionsSale = document.getElementById('product-suggestions-sale');
        let searchDebounceTimeout = null;

        const newClientModal = document.getElementById('new-client-modal');
        const closeNewClientModalBtn = document.getElementById('close-new-client-modal-btn');
        const cancelNewClientBtn = document.getElementById('cancel-new-client-btn');
        const saveNewClientBtn = document.getElementById('save-new-client-btn');
        const newClientForm = document.getElementById('new-client-form');
        const newClientModalError = document.getElementById('new-client-modal-error');
        const newClientModalErrorMessage = document.getElementById('new-client-modal-error-message');

        const defaultRate = {{ current_rate }};
        let activeRate = defaultRate;

        {% if current_user.role == 'administrador' %}
        const dateCreatedInput = document.getElementById('date_created'); // type: ignore
        const today = new Date('{{ current_ve_time.isoformat() }}');
        const todayString = today.toISOString().split('T')[0];

        // Función para recalcular todos los precios y el resumen de la orden en el frontend.
        // Esencial para actualizar la vista sin recargar la página.
        function updateAllPricesAndSummary() {
            document.querySelectorAll('tr.product-item').forEach(row => {
                const priceUsdInput = row.querySelector('.price-usd-input');
                const priceUsdDisplay = row.querySelector('.price-usd-display');
                const priceVesDisplay = row.querySelector('.price-ves-display');
                let priceUsd = 0;

                if (priceUsdInput) { // Vista de Administrador
                    priceUsd = parseFloat(priceUsdInput.value) || 0;
                } else if (priceUsdDisplay) { // Vista de no-administrador
                    priceUsd = parseFloat(priceUsdDisplay.dataset.priceUsd) || 0;
                }
                priceVesDisplay.textContent = (priceUsd * activeRate).toFixed(2);
            });
            updateOrderSummary();
        }

        dateCreatedInput.addEventListener('input', function() {
            const selectedDateString = this.value.split('T')[0];
            
            if (selectedDateString && selectedDateString !== todayString) { // type: ignore
                // Open the modal
                document.getElementById('rate-change-modal').classList.remove('hidden');
            }
        });

        // Modal logic
        const rateModal = document.getElementById('rate-change-modal');
        const cancelRateBtn = document.getElementById('cancel-rate-change-btn');
        const updateRateBtn = document.getElementById('update-rate-btn');
        const modalRateInput = document.getElementById('modal_exchange_rate');

        cancelRateBtn.addEventListener('click', () => {
            rateModal.classList.add('hidden'); // type: ignore
            // Reset date to today
            dateCreatedInput.value = '{{ current_ve_time.strftime("%Y-%m-%dT%H:%M") }}';
        });

        updateRateBtn.addEventListener('click', () => {
            const newRate = parseFloat(modalRateInput.value);
            if (!newRate || newRate <= 0) {
                alert('Por favor, ingrese una tasa de cambio válida.');
                return;
            }

            // Use fetch to call the existing update_rate endpoint
            const formData = new FormData();
            formData.append('currency', '{{ calculation_currency }}');
            formData.append('manual_rate', newRate);
            // Store the original rate in the session via a new endpoint
            formData.append('store_original_rate', 'true');
            // CORRECCIÓN: Añadir un indicador explícito de que esta es una llamada AJAX.
            formData.append('is_ajax', 'true');

            fetch("{{ url_for('main.update_exchange_rate') }}", {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // CORRECCIÓN: No recargar la página. Actualizar la tasa activa y recalcular todo.
                    activeRate = newRate;
                    updateAllPricesAndSummary(); // type: ignore
                    rateModal.classList.add('hidden');
                    // Usar Toastr para notificar al usuario del éxito.
                    toastr.success(`Tasa de cambio actualizada a ${newRate.toFixed(2)} Bs.`, 'Éxito');
                } else {
                    alert('Error al actualizar la tasa: ' + (data.message || 'Error desconocido.'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ocurrió un error de red al intentar actualizar la tasa.');
            });
        });
        {% endif %}

        let selectedClient = null;
        let debounceTimeout = null;

        function clearClientInfo() {
            clientNameSpan.textContent = '';
            clientCedulaRifSpan.textContent = '';
            clientEmailSpan.textContent = '';
            clientPhoneSpan.textContent = '';
            clientAddressSpan.textContent = '';
            clientInfoDiv.classList.add('hidden');
            clientIdInput.value = '';
            selectedClient = null;
        }

        function showClientInfo(client) {
            clientNameSpan.textContent = client.name || '';
            clientCedulaRifSpan.textContent = client.cedula_rif || '';
            clientEmailSpan.textContent = client.email || '';
            clientPhoneSpan.textContent = client.phone || '';
            clientAddressSpan.textContent = client.address || '';
            clientInfoDiv.classList.remove('hidden');
            clientIdInput.value = client.id;
            selectedClient = client;
        }

        function fetchClientSuggestions(query) {
            fetch(`/api/search_clients?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    clientSuggestions.innerHTML = '';
                    if (data.clients.length > 0) {
                        data.clients.forEach(client => {
                            const div = document.createElement('div');
                            div.textContent = `${client.name} - ${client.cedula_rif || 'Sin Cédula/RIF'}`;
                            div.classList.add('cursor-pointer', 'px-3', 'py-1', 'hover:bg-blue-200');
                            div.dataset.client = JSON.stringify(client); // Store client data
                            div.addEventListener('click', () => {
                                clientSearchInput.value = `${client.name} - ${client.cedula_rif || ''}`;
                                clientSuggestions.classList.add('hidden');
                                showClientInfo(client);
                            });
                            clientSuggestions.appendChild(div);
                        });
                        clientSuggestions.classList.remove('hidden');
                    } else {
                        clientSuggestions.classList.add('hidden');
                        clearClientInfo();
                    }
                })
                .catch(() => {
                    clientSuggestions.classList.add('hidden');
                    clearClientInfo();
                });
        }

        clientSearchInput.addEventListener('input', () => {
            const query = clientSearchInput.value.trim();
            clearClientInfo();
            clientIdInput.value = '';
            if (debounceTimeout) {
                clearTimeout(debounceTimeout);
            }
            if (query.length === 0) {
                clientSuggestions.classList.add('hidden');
                return;
            }
            debounceTimeout = setTimeout(() => {
                fetchClientSuggestions(query);
            }, 300);
        });

        clientSearchInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                const query = clientSearchInput.value.trim();
                if (query.length === 0) return;

                // If a client is already selected, do nothing on Enter
                if (selectedClient) return;

                // Check if there are visible suggestions
                const firstSuggestion = clientSuggestions.querySelector('div');
                if (firstSuggestion) {
                    // Select the first suggestion
                    const clientData = JSON.parse(firstSuggestion.dataset.client || '{}');
                    if (clientData.id) {
                        clientSearchInput.value = `${clientData.name} - ${clientData.cedula_rif || ''}`;
                        clientSuggestions.classList.add('hidden');
                        showClientInfo(clientData);
                    }
                } else {
                    // No suggestions, open the 'create new client' modal
                    openNewClientModal();
                }
            }
        });

        function openNewClientModal() {
            const searchText = clientSearchInput.value.trim();
            // Reset form
            newClientForm.reset();
            newClientModalError.classList.add('hidden');

            // Pre-populate based on search text (very basic check for number)
            if (!isNaN(searchText) && !isNaN(parseFloat(searchText))) {
                document.getElementById('new-client-cedula-rif').value = searchText;
            } else {
                document.getElementById('new-client-name').value = searchText;
            }
            newClientModal.classList.remove('hidden');
            document.getElementById('new-client-name').focus();
        }

        function closeNewClientModal() {
            newClientModal.classList.add('hidden');
        }

        // Add listeners for the new client modal
        closeNewClientModalBtn.addEventListener('click', closeNewClientModal);
        cancelNewClientBtn.addEventListener('click', closeNewClientModal);

        saveNewClientBtn.addEventListener('click', () => {
            const name = document.getElementById('new-client-name').value.trim();
            if (!name) {
                newClientModalErrorMessage.textContent = 'El nombre del cliente es obligatorio.';
                newClientModalError.classList.remove('hidden');
                return;
            }

            const clientData = {
                name: name,
                cedula_rif: document.getElementById('new-client-cedula-rif').value.trim(),
                email: document.getElementById('new-client-email').value.trim(),
                phone: document.getElementById('new-client-phone').value.trim(),
                address: document.getElementById('new-client-address').value.trim(),
            };

            fetch('/api/clientes/nuevo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(clientData)
            })
            .then(response => {
                if (!response.ok) { return response.json().then(err => { throw new Error(err.error || 'Error desconocido'); }); }
                return response.json();
            })
            .then(newClient => {
                closeNewClientModal();
                showClientInfo(newClient);
                clientSearchInput.value = `${newClient.name} - ${newClient.cedula_rif || ''}`;
                clientSuggestions.classList.add('hidden');
            })
            .catch(error => {
                newClientModalErrorMessage.textContent = error.message;
                newClientModalError.classList.remove('hidden');
            });
        });

        // Initialize product list and other existing JS code below (unchanged)...

        const productList = document.querySelector('#product-list tbody');
        const addProductBtn = document.getElementById('add-product-btn');

        // Remove default product row and store as template
        const defaultRow = productList.querySelector('tr.product-item');
        let productTemplate = null;
        if (defaultRow) {
            productTemplate = defaultRow.cloneNode(true);
            defaultRow.remove();
        }

        // Función para actualizar el precio en Bolívares
        function updatePriceVes(priceUsdInput) {
            const priceUsd = parseFloat(priceUsdInput.value) || 0;
            const priceVesDisplay = priceUsdInput.closest('tr.product-item').querySelector('.price-ves-display');
            const priceVes = (priceUsd * activeRate).toFixed(2);
            priceVesDisplay.textContent = priceVes;
        }

        // Función para inicializar los precios y el stock
        function initializeProductItem(productItem) {
            const selectElement = productItem.querySelector('.product-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const priceUsdInput = productItem.querySelector('.price-usd-input');
            const quantityInput = productItem.querySelector('.quantity-input');

            // Asignar el precio USD desde el atributo data-
            if (priceUsdInput) {
                priceUsdInput.value = selectedOption.dataset.priceUsd;
                updatePriceVes(priceUsdInput);
            } else {
                // This is for non-admin
                const priceUsd = selectedOption.dataset.priceUsd;
                const priceUsdDisplay = productItem.querySelector('.price-usd-display');
                const priceUsdHiddenInput = productItem.querySelector('.price-usd-hidden-for-submit');
                const priceVesDisplay = productItem.querySelector('.price-ves-display');
                
                // CORRECCIÓN: Asignar el precio al atributo data- del span para que updateOrderSummary() pueda leerlo.
                if (priceUsdDisplay) priceUsdDisplay.dataset.priceUsd = priceUsd;
                
                if (priceUsdDisplay) priceUsdDisplay.textContent = parseFloat(priceUsd).toFixed(2);
                if (priceUsdHiddenInput) priceUsdHiddenInput.value = priceUsd;
                if (priceVesDisplay) priceVesDisplay.textContent = (parseFloat(priceUsd) * activeRate).toFixed(2);
            }

            // Configurar validación de cantidad según stock disponible
            if (quantityInput && selectedOption.dataset.stock) {
                const availableStock = parseInt(selectedOption.dataset.stock);
                quantityInput.max = availableStock;
                quantityInput.placeholder = `Máx: ${availableStock}`;

                // Validar cantidad actual si existe
                const currentQuantity = parseInt(quantityInput.value) || 0;
                if (currentQuantity > availableStock) {
                    quantityInput.value = availableStock;
                    showStockWarning(productItem, `Cantidad ajustada al stock disponible: ${availableStock}`);
                }
            }

            // Actualizar el stock en la etiqueta del producto
            const productName = selectedOption.text.split(' (')[0];
            selectedOption.text = `${productName} (Stock: ${selectedOption.dataset.stock})`;
        }

        // Función para mostrar advertencias de stock
        function showStockWarning(productItem, message) {
            // Remover advertencias anteriores
            const existingWarning = productItem.querySelector('.stock-warning');
            if (existingWarning) {
                existingWarning.remove();
            }

            // Crear nueva advertencia
            const warningDiv = document.createElement('div');
            warningDiv.className = 'stock-warning text-red-600 text-sm font-semibold mt-1';
            warningDiv.textContent = `⚠️ ${message}`;

            // Insertar después del select
            const selectElement = productItem.querySelector('.product-select');
            selectElement.parentNode.insertBefore(warningDiv, selectElement.nextSibling);

            // Remover advertencia después de 5 segundos
            setTimeout(() => {
                if (warningDiv.parentNode) {
                    warningDiv.remove();
                }
            }, 5000);
        }

        // Función para validar cantidad en tiempo real
        function validateQuantityInput(quantityInput) {
            const productItem = quantityInput.closest('tr.product-item');
            const selectElement = productItem.querySelector('.product-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];

            if (!selectedOption || !selectedOption.dataset.stock) return;

            const availableStock = parseInt(selectedOption.dataset.stock);
            const requestedQuantity = parseInt(quantityInput.value) || 0;

            // Remover clases de validación anteriores
            quantityInput.classList.remove('border-red-500', 'border-green-500');

            if (requestedQuantity > availableStock) {
                quantityInput.classList.add('border-red-500');
                showStockWarning(productItem, `Stock insuficiente. Disponible: ${availableStock}, Solicitado: ${requestedQuantity}`);
                // No permitir valores superiores al stock
                quantityInput.value = availableStock;
                updateOrderSummary();
            } else if (requestedQuantity > 0) {
                quantityInput.classList.add('border-green-500');
            }

            // Mostrar advertencia si el stock está bajo
            if (availableStock < 5 && requestedQuantity > 0) {
                showStockWarning(productItem, `¡Atención! Stock bajo (${availableStock} unidades disponibles)`);
            }
        }

        // Event listener para actualizar el precio en Bs al cambiar el producto
        productList.addEventListener('change', function(event) {
            if (event.target.classList.contains('product-select')) {
                initializeProductItem(event.target.closest('tr.product-item'));
            }
        });
        
        // Event listener para recalcular el precio en Bs cuando se edita el precio USD
        productList.addEventListener('input', function(event) {
            if (event.target.classList.contains('price-usd-input')) {
                updatePriceVes(event.target);
            }
        });

        // Inicializar el primer producto
        document.querySelectorAll('tr.product-item').forEach(initializeProductItem);

        // Event listener para agregar un nuevo producto
        addProductBtn.addEventListener('click', function() {
            const newProductItem = productTemplate.cloneNode(true);

            // Limpiar valores del nuevo clon
            newProductItem.querySelector('.product-select').selectedIndex = 0;
            newProductItem.querySelector('.quantity-input').value = ''; // type: ignore
            {% if current_user.is_authenticated and current_user.role == 'administrador' %}
            const priceUsdInput = newProductItem.querySelector('.price-usd-input');
            if (priceUsdInput) {
                priceUsdInput.value = '';
            }
            {% endif %}

            // Habilitar el botón de eliminar // type: ignore
            const removeBtn = newProductItem.querySelector('.remove-product-btn');
            removeBtn.disabled = false;
            removeBtn.style.display = 'inline-block';

            // Inicializar el nuevo clon
            initializeProductItem(newProductItem);

            productList.appendChild(newProductItem);
        });

        // Event listener para eliminar una fila de producto
        productList.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-product-btn') || event.target.closest('.remove-product-btn')) {
                const productItem = event.target.closest('tr.product-item');
                productItem.remove();
                updateOrderSummary();
            }
        });

        // Función para actualizar el código del producto
        function updateProductCodeDisplay(productItem) {
            const selectElement = productItem.querySelector('.product-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const codigoDisplay = productItem.querySelector('.codigo-producto-display');
            const codigo = selectedOption.dataset.codigo || 'Sin código';
            codigoDisplay.textContent = `Código: ${codigo}`;
        }

        // Actualizar códigos de producto al inicializar
        document.querySelectorAll('tr.product-item').forEach(updateProductCodeDisplay);

        // Event listener para actualizar código al cambiar producto
        productList.addEventListener('change', function(event) {
            if (event.target.classList.contains('product-select')) {
                updateProductCodeDisplay(event.target.closest('tr.product-item'));
                updateOrderSummary();
            }
        });

        // Event listener para actualizar resumen al cambiar cantidad o precio
        productList.addEventListener('input', function(event) {
            if (event.target.classList.contains('quantity-input')) {
                // Validar cantidad contra stock disponible
                validateQuantityInput(event.target);
                updateOrderSummary();
            } else if (event.target.classList.contains('price-usd-input')) {
                updatePriceVes(event.target);
                updateOrderSummary();
            }
        });

        // Event listener para actualizar resumen al cambiar el descuento
        const discountEnabledCheckbox = document.getElementById('discount-enabled-checkbox');
        const discountInput = document.getElementById('discount-input');

        discountEnabledCheckbox.addEventListener('change', function() {
            if (this.checked) {
                discountInput.disabled = false;
                discountInput.focus();
            } else {
                discountInput.disabled = true;
                discountInput.value = '0.00';
                // Disparar el evento 'input' para que se actualice el resumen
                discountInput.dispatchEvent(new Event('input'));
            }
        });

        discountInput.addEventListener('input', function() {
            updateOrderSummary();
        });
        
        // Función para calcular y actualizar el resumen de la orden
        function updateOrderSummary() {
            let subtotal = 0;
            
            document.querySelectorAll('tr.product-item').forEach(productItem => {
                const quantity = parseFloat(productItem.querySelector('.quantity-input').value) || 0;
                const priceUsdInput = productItem.querySelector('.price-usd-input');
                let priceUsd = 0;
                if (priceUsdInput) {
                    priceUsd = parseFloat(priceUsdInput.value) || 0; // type: ignore
                } else {
                    // For non-admin users, use the default price from the selected option
                    const priceUsdDisplay = productItem.querySelector('.price-usd-display');
                    // Usamos un atributo de datos para mantener el precio original en USD
                    priceUsd = parseFloat(priceUsdDisplay.dataset.priceUsd) || 0;
                }
                const priceVes = priceUsd * activeRate;

                const rowTotal = quantity * priceVes;
                const rowTotalDisplay = productItem.querySelector('.row-total-display');
                if (rowTotalDisplay) {
                    rowTotalDisplay.textContent = rowTotal.toFixed(2);
                }

                subtotal += rowTotal;
            });

            let discountUsd = 0;
            if (discountEnabledCheckbox.checked) {
                discountUsd = parseFloat(discountInput.value) || 0;
            }

            const discountVes = discountUsd * activeRate;

            const iva = 0; // IVA desactivado
            const total = subtotal - discountVes;

            document.getElementById('subtotal-display').textContent = subtotal.toFixed(2) + ' Bs';
            document.getElementById('iva-display').textContent = iva.toFixed(2) + ' Bs';
            document.getElementById('total-display').textContent = Math.max(0, total).toFixed(2) + ' Bs';
        }

        // Inicializar resumen de la orden
        updateOrderSummary();

        // --- Nueva Lógica para Búsqueda por Palabra Clave ---

        function addProductToTable(product) {
            // Verificar si el producto ya está en la lista
            let existingRow = null;
            document.querySelectorAll('tr.product-item').forEach(item => {
                const selectElement = item.querySelector('.product-select');
                if (selectElement.value == product.id) {
                    existingRow = item;
                }
            });

            if (existingRow) {
                // Incrementar cantidad si ya existe
                const quantityInput = existingRow.querySelector('.quantity-input');
                const currentQuantity = parseInt(quantityInput.value) || 0;
                const maxStock = parseInt(quantityInput.max) || 0;
                if (currentQuantity < maxStock) {
                    quantityInput.value = currentQuantity + 1;
                    validateQuantityInput(quantityInput);
                    updateOrderSummary();
                    quantityInput.focus();
                } else {
                    toastr.warning('No se puede agregar más, stock máximo alcanzado.', 'Stock Insuficiente');
                }
            } else {
                // Agregar nueva fila si no existe
                const newProductItem = productTemplate.cloneNode(true);

                // Seleccionar el producto en el dropdown
                const selectElement = newProductItem.querySelector('.product-select');
                for (let i = 0; i < selectElement.options.length; i++) {
                    if (selectElement.options[i].value == product.id) {
                        selectElement.selectedIndex = i;
                        break;
                    }
                }

                // Habilitar botón de eliminar
                const removeBtn = newProductItem.querySelector('.remove-product-btn');
                removeBtn.disabled = false;
                removeBtn.style.display = 'inline-block';

                // Inicializar el nuevo producto
                initializeProductItem(newProductItem);
                updateProductCodeDisplay(newProductItem);

                // Establecer cantidad predeterminada a 1
                const quantityInput = newProductItem.querySelector('.quantity-input');
                quantityInput.value = '1';

                // Agregar a la lista
                productList.appendChild(newProductItem);

                // Actualizar resumen y validar
                validateQuantityInput(quantityInput);
                updateOrderSummary();
                quantityInput.focus();
            }

            keywordSearchInput.value = '';
            productSuggestionsSale.classList.add('hidden');
        }

        keywordSearchInput.addEventListener('input', function() {
            const query = this.value.trim();

            if (query.length < 2) {
                productSuggestionsSale.classList.add('hidden');
                return;
            }

            clearTimeout(searchDebounceTimeout);
            searchDebounceTimeout = setTimeout(() => {
                fetch(`/api/search_products_for_sale?q=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => {
                        productSuggestionsSale.innerHTML = '';
                        if (data.products && data.products.length > 0) {
                            data.products.forEach(product => {
                                const div = document.createElement('div');
                                div.className = 'p-2 hover:bg-blue-100 cursor-pointer';
                                div.innerHTML = `
                                    <div class="font-semibold">${product.name}</div>
                                    <div class="text-sm text-gray-600">
                                        <span>Cód. Interno: ${product.codigo_producto || 'N/A'}</span> | <span>Cód. Barras: ${product.barcode}</span> | <span class="font-bold">Stock: ${product.stock}</span>
                                    </div>
                                `;
                                div.addEventListener('click', () => addProductToTable(product));
                                productSuggestionsSale.appendChild(div);
                            });
                            productSuggestionsSale.classList.remove('hidden');
                        } else {
                            productSuggestionsSale.classList.add('hidden');
                        }
                    });
            }, 300);
        });

        document.addEventListener('click', function(e) {
            if (!keywordSearchInput.contains(e.target) && !productSuggestionsSale.contains(e.target)) {
                productSuggestionsSale.classList.add('hidden');
            }
        });

        // Función para agregar producto por código de barras
        document.getElementById('barcode-input').addEventListener('keypress', function(e) {
            if (e.key !== 'Enter') return;
            e.preventDefault();

            const barcode = this.value.trim();
            if (!barcode) {
                return;
            }

            fetch(`/api/product_by_barcode/${barcode}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Producto no encontrado');
                    }
                    return response.json();
                })
                .then(product => {
                    // Reutilizamos la función addProductToTable que ya maneja la lógica de agregar o incrementar.
                    addProductToTable(product);

                    // Limpiar input de código de barras y devolver el cursor
                    this.value = '';
                    this.focus();
                })
                .catch(error => {
                    toastr.error(error.message, 'Error');
                    this.focus();
                });
        });

        // --- Lógica del Modal de Pago ---
        const paymentModal = document.getElementById('payment-modal');
        const mainActionBtn = document.getElementById('main-action-btn');
        const closeModalBtn = document.getElementById('close-modal-btn'); // type: ignore
        const saleTypeSelect = document.getElementById('sale_type');
        const finalizeOrderBtn = document.getElementById('finalize-order-btn');
        const addPaymentBtnModal = document.getElementById('add-payment-btn-modal');

        // Nuevos elementos para la lógica de Entrega Especial
        const financialSummarySection = document.getElementById('financial-summary-section');
        const specialDispatchReasonSection = document.getElementById('special-dispatch-reason-section');
        const dispatchReasonTextarea = document.getElementById('dispatch_reason');

        const modalTotalAmount = document.getElementById('modal-total-amount');
        const modalPaidAmount = document.getElementById('modal-paid-amount');
        const modalRemainingAmount = document.getElementById('modal-remaining-amount');
        const modalTotalAmountUsd = document.getElementById('modal-total-amount-usd');
        const modalPaidAmountUsd = document.getElementById('modal-paid-amount-usd');
        const modalRemainingAmountUsd = document.getElementById('modal-remaining-amount-usd');
        const modalChangeDisplay = document.getElementById('modal-change-display'); // type: ignore
        const modalChangeAmount = document.getElementById('modal-change-amount');
        const creditSaleNotice = document.getElementById('credit-sale-notice');
        
        const paymentMethodSelect = document.getElementById('payment-method'); // type: ignore
        const paymentAmountInput = document.getElementById('payment-amount');
        const paymentReferenceGroup = document.getElementById('payment-reference-group');
        const paymentReferenceInput = document.getElementById('payment-reference');
        const paymentIssuingBankGroup = document.getElementById('payment-issuing-bank-group');
        const paymentIssuingBankInput = document.getElementById('payment-issuing-bank');
        const paymentSenderIdGroup = document.getElementById('payment-sender-id-group');
        const paymentSenderIdInput = document.getElementById('payment-sender-id');
        const paymentBankGroup = document.getElementById('payment-bank-group');
        const paymentBankSelect = document.getElementById('payment-bank');
        const paymentPosGroup = document.getElementById('payment-pos-group'); // type: ignore
        const paymentPosSelect = document.getElementById('payment-pos');
        const paymentCurrencyGroup = document.getElementById('payment-currency-group');
        const paymentCurrencySelect = document.getElementById('payment-currency');
        const paymentCashboxGroup = document.getElementById('payment-cashbox-group'); // type: ignore
        const paymentCashboxSelect = document.getElementById('payment-cashbox'); // type: ignore

        const paymentsListDiv = document.getElementById('payments-list');
        const paymentsDataInput = document.getElementById('payments-data-input');

        let payments = [];
        let orderTotal = 0;
        let previousPaymentMethod = paymentMethodSelect.value;
        let previousTransferCurrency = paymentCurrencySelect.value; // type: ignore

        function updatePaymentAmountInput() {
            const totalPaid = payments.reduce((sum, p) => sum + p.amount_ves_equivalent, 0);
            let remaining = orderTotal - totalPaid;

            if (remaining <= 0.01) {
                paymentAmountInput.value = '';
                return;
            }

            const method = paymentMethodSelect.value; // type: ignore
            const transfer_currency = paymentCurrencySelect.value;

            if ((method === 'efectivo_usd') || (method === 'transferencia' && transfer_currency === 'USD')) {
                if (activeRate > 0) {
                    const amountUsd = remaining / activeRate;
                    paymentAmountInput.value = amountUsd.toFixed(2);
                } else {
                    paymentAmountInput.value = '0.00'; // Avoid division by zero
                }
            } else { // For VES methods
                paymentAmountInput.value = remaining.toFixed(2);
            }
        }

        function openPaymentModal() {
            updateOrderSummary(); // Asegurarse de que el total está actualizado
            orderTotal = parseFloat(document.getElementById('total-display').textContent) || 0; // type: ignore

            if (orderTotal <= 0) {
                alert("Agregue productos a la orden antes de procesar el pago.");
                return;
            }

            const selectedSaleType = saleTypeSelect.value;

            // Show/hide notices in modal
            creditSaleNotice.classList.add('hidden'); // Hide all notices first // type: ignore

            if (selectedSaleType === 'credit') {
                creditSaleNotice.classList.remove('hidden');
                creditSaleNotice.querySelector('p.font-bold').textContent = 'Venta a Crédito';
                creditSaleNotice.querySelector('p:not(.font-bold)').textContent = 'Puede registrar un abono inicial o finalizar la orden sin pagos. El saldo pendiente se registrará en la cuenta del cliente.';
                finalizeOrderBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Finalizar y Crear Crédito';
            } else if (selectedSaleType === 'reservation') {
                creditSaleNotice.classList.remove('hidden');
                creditSaleNotice.querySelector('p.font-bold').textContent = 'Sistema de Apartado';
                creditSaleNotice.querySelector('p:not(.font-bold)').textContent = 'Registre un abono para reservar los productos. El saldo pendiente se puede pagar después.';
                finalizeOrderBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Registrar Apartado';
            } else { // regular
                finalizeOrderBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Finalizar y Crear Orden';
            }

            const discountEnabled = document.getElementById('discount-enabled-checkbox').checked;
            const discountUsd = discountEnabled ? (parseFloat(document.getElementById('discount-input').value) || 0) : 0; // type: ignore
            const paymentMethodSelect = document.getElementById('payment-method');
            const restrictionMessage = document.getElementById('payment-restriction-message');
            if (discountEnabled && discountUsd > 0) {
                // Restrict payment methods to cash USD
                restrictionMessage.classList.remove('hidden');
                for (let option of paymentMethodSelect.options) {
                    if (option.value !== 'efectivo_usd') {
                        option.style.display = 'none';
                    } else {
                        option.style.display = ''; // Ensure it's visible
                    }
                }
                paymentMethodSelect.value = 'efectivo_usd';
            } else {
                // Ensure all options are visible if no discount
                restrictionMessage.classList.add('hidden');
                for (let option of paymentMethodSelect.options) {
                    option.style.display = '';
                }
                // Reset to default if needed
                paymentMethodSelect.value = 'efectivo_ves';
            }
            // Trigger change to update conditional fields (like cashbox, bank, etc.)
            paymentMethodSelect.dispatchEvent(new Event('change'));

            modalTotalAmount.textContent = orderTotal.toFixed(2) + ' Bs'; // type: ignore
            modalTotalAmountUsd.textContent = (orderTotal / activeRate).toFixed(2) + ' {{ currency_symbol }}';
            updatePaymentSummary(); // This will set up the initial state of the modal correctly
            paymentModal.classList.remove('hidden');
        }

        function closePaymentModal() {
            paymentModal.classList.add('hidden');
            payments = []; // Limpiar pagos si se cierra el modal
            paymentsListDiv.innerHTML = ''; // type: ignore
            modalChangeDisplay.classList.add('hidden');
        }

        function updatePaymentSummary() {
            const totalPaid = payments.reduce((sum, p) => sum + p.amount_ves_equivalent, 0);
            const remaining = orderTotal - totalPaid;

            modalPaidAmount.textContent = totalPaid.toFixed(2) + ' Bs'; // type: ignore
            modalPaidAmountUsd.textContent = (totalPaid / activeRate).toFixed(2) + ' {{ currency_symbol }}';
            modalRemainingAmountUsd.textContent = (Math.max(0, remaining) / activeRate).toFixed(2) + ' {{ currency_symbol }}';


            // Handle change display
            if (remaining < -0.001) { // Overpaid, show change
                const change = Math.abs(remaining);
                const changeInBs = change.toFixed(2);
                const changeInForeign = (change / activeRate).toFixed(2);
                modalChangeAmount.textContent = `Bs ${changeInBs} / {{ currency_symbol }}${changeInForeign}`; // type: ignore
                modalChangeDisplay.classList.remove('hidden');
            } else {
                modalChangeDisplay.classList.add('hidden');
            }

            // Handle remaining amount display and input field
            if (remaining > 0.01) { // Amount is still pending
                modalRemainingAmount.textContent = remaining.toFixed(2) + ' Bs'; // type: ignore
                modalRemainingAmount.classList.remove('text-green-600');
                modalRemainingAmount.classList.add('text-red-600');
                // The button is now always enabled to allow showing a message on click.
                // Validation is moved to the button's click event listener.
                finalizeOrderBtn.disabled = false;
            } else { // Paid in full or overpaid
                modalRemainingAmount.textContent = '0.00 Bs';
                modalRemainingAmount.classList.remove('text-red-600');
                modalRemainingAmount.classList.add('text-green-600');
                finalizeOrderBtn.disabled = false;
            }
            updatePaymentAmountInput();
        }

        function addPayment() {
            const method = paymentMethodSelect.value; // type: ignore
            const amount = parseFloat(paymentAmountInput.value);
            const reference = paymentReferenceInput.value;
            const issuing_bank = paymentIssuingBankInput.value;
            const sender_id = paymentSenderIdInput.value;
            const bank_id = paymentBankSelect.value;
            const transfer_currency = paymentCurrencySelect.value; // type: ignore
            const pos_id = paymentPosSelect.value;
            const cash_box_id = paymentCashboxSelect.value;

            if (!amount || amount <= 0) {
                alert("Por favor, ingrese un monto válido.");
                return;
            }

            // Validar selección de destino
            if (method === 'transferencia' && !bank_id) { // This validation is now more complex due to currency filtering
                alert("Por favor, seleccione un banco de destino.");
                return;
            }
            if (method === 'punto_de_venta' && !pos_id) {
                alert("Por favor, seleccione un punto de venta.");
                return;
            }
            if (method.startsWith('efectivo') && !cash_box_id) {
                alert("Por favor, seleccione una caja.");
                return;
            }

            let amount_ves_equivalent = amount;
            let currency_paid = 'VES';

            if (method === 'efectivo_usd' || (method === 'transferencia' && transfer_currency === 'USD')) {
                amount_ves_equivalent = amount * activeRate;
                currency_paid = 'USD';
            }


            const payment = {
                method: method,
                amount_paid: amount,
                currency_paid: currency_paid,
                amount_ves_equivalent: amount_ves_equivalent,
                reference: reference,
                issuing_bank: method === 'transferencia' ? issuing_bank : null,
                sender_id: method === 'transferencia' ? sender_id : null,
                bank_id: method === 'transferencia' ? parseInt(bank_id) : null,
                pos_id: method === 'punto_de_venta' ? parseInt(pos_id) : null,
                cash_box_id: method.startsWith('efectivo') ? parseInt(cash_box_id) : null,
            };

            payments.push(payment);
            renderPayments();
            updatePaymentSummary();

            // Limpiar formulario de pago
            paymentAmountInput.value = '';
            paymentReferenceInput.value = '';
            paymentIssuingBankInput.value = '';
            paymentSenderIdInput.value = '';
            paymentBankSelect.selectedIndex = 0;
            paymentPosSelect.selectedIndex = 0;
            paymentCashboxSelect.selectedIndex = 0;
        }

        function renderPayments() {
            paymentsListDiv.innerHTML = ''; // type: ignore
            payments.forEach((p, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                
                const paymentMethodName = p.method.replace(/_/g, ' ');
                let iconHtml = '';

                for (const [bankName, iconFile] of Object.entries(BANK_ICONS)) {
                    if (paymentMethodName.toLowerCase() === bankName.toLowerCase()) {
                        iconHtml = `<img src="/static/img/bancos/${iconFile}" alt="${bankName}" class="inline-block h-6 w-6 mr-2" title="${bankName}">`;
                        break;
                    }
                }

                let details = `${paymentMethodName}: ${p.amount_paid.toFixed(2)} ${p.currency_paid} (Equiv. ${p.amount_ves_equivalent.toFixed(2)} Bs)`;
                if (p.reference) {
                    details += ` - Ref: ${p.reference}`;
                }
                if (p.issuing_bank) {
                    details += ` - Banco: ${p.issuing_bank}`;
                }
                if (p.sender_id) {
                    details += ` - Emisor: ${p.sender_id}`;
                }
                div.innerHTML = `
                    <span class="flex items-center">${iconHtml} ${details}</span>
                    <button type="button" data-index="${index}" class="remove-payment-btn text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                `;
                paymentsListDiv.appendChild(div);
            });
        }

        mainActionBtn.addEventListener('click', handleMainAction);
        closeModalBtn.addEventListener('click', closePaymentModal); // type: ignore
        addPaymentBtnModal.addEventListener('click', addPayment);
        
        paymentMethodSelect.addEventListener('change', function() {
            const newMethod = this.value;
            const amount = parseFloat(paymentAmountInput.value);

            function filterBankOptions() {
                const selectedCurrency = paymentCurrencySelect.value; // type: ignore
                const bankOptions = paymentBankSelect.options;
                let firstVisibleOption = null;

                for (let i = 1; i < bankOptions.length; i++) { // Skip "Seleccione un banco"
                    const option = bankOptions[i];
                    if (option.dataset.currency === selectedCurrency) {
                        option.style.display = '';
                        if (!firstVisibleOption) firstVisibleOption = option;
                    } else {
                        option.style.display = 'none';
                    }
                }
                // If the currently selected bank is now hidden, reset selection
                if (paymentBankSelect.selectedOptions.length > 0 && paymentBankSelect.selectedOptions[0].style.display === 'none') {
                    paymentBankSelect.value = '';
                }
            }

            // Toggle conditional fields first
            const isTransfer = newMethod === 'transferencia';
            [paymentReferenceGroup, paymentIssuingBankGroup, paymentSenderIdGroup, paymentBankGroup, paymentCurrencyGroup].forEach(el => el.classList.toggle('hidden', !isTransfer));
            paymentPosGroup.classList.toggle('hidden', newMethod !== 'punto_de_venta');
            paymentCashboxGroup.classList.toggle('hidden', !newMethod.startsWith('efectivo'));

            if (newMethod === 'transferencia') {
                if (selectedClient && selectedClient.phone) {
                    paymentSenderIdInput.value = selectedClient.phone;
                } else {
                    paymentSenderIdInput.value = '';
                }
                // When transfer is selected, filter banks based on the current currency selection
                filterBankOptions();
            } else {
                paymentBankSelect.value = ''; // Reset bank selection if not a transfer
            }

            const newTransferCurrency = paymentCurrencySelect.value; // type: ignore

            if (amount && amount > 0) {
                const wasUsd = previousPaymentMethod === 'efectivo_usd' || (previousPaymentMethod === 'transferencia' && previousTransferCurrency === 'USD');
                const isUsd = newMethod === 'efectivo_usd' || (newMethod === 'transferencia' && newTransferCurrency === 'USD');

                if (wasUsd && !isUsd && activeRate > 0) {
                    // Convert from USD to VES
                    paymentAmountInput.value = (amount * activeRate).toFixed(2);
                } else if (!wasUsd && isUsd && activeRate > 0) {
                    // Convert from VES to USD
                    paymentAmountInput.value = (amount / activeRate).toFixed(2);
                }
                // If currencies are the same (e.g., VES to VES), do nothing to the amount.

            } else {
                // If no amount is entered, use the default behavior of filling with remaining
                updatePaymentAmountInput();
            }
            
            // Update the previous method for the next change
            previousPaymentMethod = newMethod;
            previousTransferCurrency = newTransferCurrency; // type: ignore
        });

        // Add event listener for the new currency dropdown for transfers
        paymentCurrencySelect.addEventListener('change', function() {
            // When currency changes, re-filter the bank list
            paymentMethodSelect.dispatchEvent(new Event('change'));
        });

        paymentsListDiv.addEventListener('click', function(e) {
            if (e.target.closest('.remove-payment-btn')) {
                const index = e.target.closest('.remove-payment-btn').dataset.index;
                payments.splice(index, 1);
                renderPayments();
                updatePaymentSummary();
            }
        });

        // --- LOGIC FOR SALE TYPE CHANGE ---
        saleTypeSelect.addEventListener('change', function() {
            const saleType = this.value;
            mainActionBtn.classList.remove('bg-green-500', 'bg-blue-600', 'bg-yellow-500', 'bg-red-600'); // Remove all color classes
            
            const isSpecialDispatch = saleType === 'special_dispatch';
            financialSummarySection.classList.toggle('hidden', isSpecialDispatch);
            specialDispatchReasonSection.classList.toggle('hidden', !isSpecialDispatch);
            dispatchReasonTextarea.required = isSpecialDispatch;

            if (saleType === 'credit') {
                mainActionBtn.innerHTML = '<i class="fas fa-hand-holding-usd mr-2"></i>Registrar Abono / Crear Crédito';
                mainActionBtn.classList.add('bg-blue-600');
            } else if (saleType === 'reservation') {
                mainActionBtn.innerHTML = '<i class="fas fa-box-open mr-2"></i>Procesar Apartado';
                mainActionBtn.classList.add('bg-yellow-500');
            } else if (isSpecialDispatch) {
                mainActionBtn.innerHTML = '<i class="fas fa-truck mr-2"></i>Crear Entrega Especial';
                mainActionBtn.classList.add('bg-red-600');
            } else { // regular
                mainActionBtn.innerHTML = '<i class="fas fa-dollar-sign mr-2"></i>Procesar Pago y Crear Orden';
                mainActionBtn.classList.add('bg-green-500');
            }
        });
        saleTypeSelect.dispatchEvent(new Event('change')); // Trigger on load

        function handleMainAction() {
            const selectedSaleType = saleTypeSelect.value;

            if (selectedSaleType === 'special_dispatch') {
                // For special dispatch, we don't open the payment modal.
                // We directly trigger the stock check and form submission logic.
                // We can reuse the logic from finalizeOrderBtn.
                finalizeOrderBtn.click();
            } else {
                // For all other sale types, open the payment modal.
                openPaymentModal();
            }
        }

        mainActionBtn.addEventListener('click', function() {
            const originalButtonHtml = this.innerHTML;
            const button = this;

            // Disable button and show verification message
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verificando...';

            // --- Validation logic ---
            const selectedSaleType = saleTypeSelect.value;
            const totalPaid = payments.reduce((sum, p) => sum + p.amount_ves_equivalent, 0);
            const remaining = orderTotal - totalPaid;

            if (selectedSaleType === 'special_dispatch') {
                // Validation for special dispatch
                if (!dispatchReasonTextarea.value.trim()) {
                    alert('El motivo de la entrega es obligatorio.');
                    button.disabled = false;
                    button.innerHTML = originalButtonHtml;
                    return;
                }
            } else {
                // Payment validation for other types
                if (payments.length === 0) {
                    if (selectedSaleType === 'regular') {
                        alert('No ha agregado ningún pago. Para una Venta Regular, debe registrar el pago completo.');
                        button.disabled = false;
                        button.innerHTML = originalButtonHtml;
                        return;
                    } else { 
                        if (!confirm('No ha agregado ningún pago inicial. ¿Desea crear la orden con el saldo total pendiente?')) {
                            button.disabled = false;
                            button.innerHTML = originalButtonHtml;
                            return;
                        }
                    }
                } 
                else if (selectedSaleType === 'regular' && remaining > 0.01) {
                    alert('El monto pagado no cubre el total de la orden. Para una Venta Regular, debe registrar el pago completo.');
                    button.disabled = false;
                    button.innerHTML = originalButtonHtml;
                    return;
                }
            }

            // --- Real-time stock check ---
            const productItems = [];
            document.querySelectorAll('tr.product-item').forEach(row => {
                const productId = row.querySelector('.product-select').value;
                const quantity = parseInt(row.querySelector('.quantity-input').value, 10);
                if (productId && quantity > 0) {
                    productItems.push({ id: productId, quantity: quantity });
                }
            });

            if (productItems.length === 0) {
                alert('No hay productos en la orden.');
                button.disabled = false;
                button.innerHTML = originalButtonHtml;
                return;
            }

            // For special dispatch by non-managers, we don't check stock here, the backend will handle it upon approval.
            const shouldCheckStockNow = selectedSaleType !== 'special_dispatch' || {{ 'true' if is_gerente() else 'false' }};

            if (shouldCheckStockNow) {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verificando stock...';
                fetch('/api/check_stock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ products: productItems })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        submitOrderForm(button);
                    } else {
                        let errorMessage = 'No se puede procesar la orden por falta de stock:\n\n';
                        if (data.errors) {
                            data.errors.forEach(err => {
                                errorMessage += `• ${err.name}: Solicitado: ${err.requested}, Disponible: ${err.stock}\n`;
                            });
                        }
                        alert(errorMessage);
                        button.disabled = false;
                        button.innerHTML = originalButtonHtml;
                    }
                })
                .catch(error => {
                    console.error('Error checking stock:', error);
                    alert('Ocurrió un error al verificar el stock. Por favor, intente de nuevo.');
                    button.disabled = false;
                    button.innerHTML = originalButtonHtml;
                });
            } else {
                // For special dispatch by sellers, skip frontend stock check and submit directly.
                submitOrderForm(button);
            }
        }

        function submitOrderForm(button) {
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Procesando...';
            paymentsDataInput.value = JSON.stringify(payments);
            document.getElementById('order-form').submit();
        }

        mainActionBtn.addEventListener('click', handleMainAction);
        finalizeOrderBtn.addEventListener('click', finalizeOrder);

        // Disparar el evento change al cargar para establecer el estado inicial correcto
        paymentMethodSelect.dispatchEvent(new Event('change'));
    });
</script>
{% endblock %}