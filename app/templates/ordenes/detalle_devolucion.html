{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4 max-w-5xl">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-receipt mr-2"></i>Detalle de Devolución</h1>
            <p class="text-gray-500 font-mono">Código: {{ return_record.return_code }}</p>
        </div>
        <a href="{{ url_for('main.return_list') }}" class="text-blue-500 hover:text-blue-700">
            <i class="fas fa-arrow-left mr-2"></i>Volver al Historial
        </a>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
        <!-- Return Details -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 border-b pb-6">
            <div>
                <h2 class="text-lg font-semibold text-gray-700 mb-2">Información General</h2>
                <div class="space-y-1 text-sm text-gray-600">
                    <p><strong>Fecha:</strong> {{ return_record.date|ve_datetime }}</p>
                    <p><strong>Tipo:</strong> <span class="font-semibold">{{ return_record.return_type }}</span></p>
                    <p><strong>Motivo:</strong> {{ return_record.reason }}</p>
                    <p><strong>Procesado por:</strong> {{ return_record.user.username }}</p>
                </div>
            </div>
            <div>
                <h2 class="text-lg font-semibold text-gray-700 mb-2">Orden Original</h2>
                <div class="space-y-1 text-sm text-gray-600">
                    <p><strong>ID Orden:</strong> <a href="{{ url_for('main.order_detail', order_id=return_record.order_id) }}" class="text-blue-600 hover:underline">#{{ return_record.order_id|order_id_format }}</a></p>
                    <p><strong>Cliente:</strong> {{ return_record.order.client.name }}</p>
                    <p><strong>Fecha Orden:</strong> {{ return_record.order.date_created|ve_datetime }}</p>
                </div>
            </div>
            <div class="text-right">
                <h2 class="text-lg font-semibold text-gray-700 mb-2">Valor Total Devuelto</h2>
                <p class="text-3xl font-bold text-red-600">{{ "%.2f Bs"|format(return_record.total_refund_value_ves) }}</p>
                <p class="text-xs text-gray-500 mt-1">(Valor histórico de los productos recibidos)</p>
            </div>
        </div>

        <!-- Returned Items (Entrada) -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">
                {% if return_record.return_type == 'Intercambio' %}
                    Productos Recibidos (Entrada)
                {% else %}
                    Productos Devueltos
                {% endif %}
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white text-sm">
                    <thead class="bg-red-50">
                        <tr>
                            <th class="py-2 px-4 text-left font-semibold text-gray-600">Producto</th>
                            <th class="py-2 px-4 text-center font-semibold text-gray-600">Cantidad</th>
                            <th class="py-2 px-4 text-right font-semibold text-gray-600">Precio Unit. (Bs)</th>
                            <th class="py-2 px-4 text-right font-semibold text-gray-600">Subtotal (Bs)</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 divide-y divide-gray-200">
                        {% for item in return_record.items %}
                        <tr>
                            <td class="py-2 px-4">{{ item.product.name }}</td>
                            <td class="py-2 px-4 text-center">{{ item.quantity }}</td>
                            <td class="py-2 px-4 text-right">{{ "%.2f"|format(item.price_at_return_ves) }}</td>
                            <td class="py-2 px-4 text-right font-semibold">{{ "%.2f"|format(item.quantity * item.price_at_return_ves) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Exchanged Items (Salida) - Only for Exchanges -->
        {% if exchanged_items %}
        <div class="mb-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Productos Entregados (Salida - Intercambio)</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white text-sm">
                    <thead class="bg-green-50">
                        <tr>
                            <th class="py-2 px-4 text-left font-semibold text-gray-600">Producto</th>
                            <th class="py-2 px-4 text-center font-semibold text-gray-600">Cantidad</th>
                            <th class="py-2 px-4 text-left font-semibold text-gray-600">Códigos</th>
                            <th class="py-2 px-4 text-right font-semibold text-gray-600">Precio (USD)</th>
                            <th class="py-2 px-4 text-right font-semibold text-gray-600">Total (USD)</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 divide-y divide-gray-200">
                        {% for item in exchanged_items %}
                        <tr>
                            <td class="py-2 px-4">{{ item.product.name }}</td>
                            <td class="py-2 px-4 text-center font-bold">{{ item.quantity }}</td>
                            <td class="py-2 px-4 text-sm text-gray-500">
                                <div><i class="fas fa-barcode mr-1"></i> {{ item.product.barcode }}</div>
                                {% if item.product.codigo_producto %}<div><i class="fas fa-tag mr-1"></i> {{ item.product.codigo_producto }}</div>{% endif %}
                            </td>
                            <td class="py-2 px-4 text-right">{{ "%.2f"|format(item.price_at_exchange_usd) }} $</td>
                            <td class="py-2 px-4 text-right font-semibold">{{ "%.2f"|format(item.quantity * item.price_at_exchange_usd) }} $</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Refund/Payment Details -->
        <div>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Movimientos Financieros (Diferencia)</h3>
            {% if return_record.refund_movements.all() %}
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white text-sm">
                        <thead class="bg-blue-50">
                            <tr>
                                <th class="py-2 px-4 text-left font-semibold text-gray-600">Fecha</th>
                                <th class="py-2 px-4 text-left font-semibold text-gray-600">Tipo</th>
                                <th class="py-2 px-4 text-left font-semibold text-gray-600">Cuenta Afectada</th>
                                <th class="py-2 px-4 text-right font-semibold text-gray-600">Monto</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700 divide-y divide-gray-200">
                            {% for refund in return_record.refund_movements %}
                            <tr>
                                <td class="py-2 px-4">{{ refund.date|ve_datetime }}</td>
                                <td class="py-2 px-4">
                                    {% if refund.movement_type == 'Egreso' %}
                                        <span class="text-red-600 font-bold">Reembolso (Salida)</span>
                                    {% else %}
                                        <span class="text-green-600 font-bold">Pago Adicional (Entrada)</span>
                                    {% endif %}
                                </td>
                                <td class="py-2 px-4">{{ refund.cash_box.name if refund.cash_box else refund.bank.name }}</td>
                                <td class="py-2 px-4 text-right font-semibold">{{ "%.2f %s"|format(refund.amount, refund.currency) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-gray-500 italic">No se registraron movimientos financieros (Cambio parejo o sin reembolso).</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
