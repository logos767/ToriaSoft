{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4 max-w-full">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-warehouse mr-2"></i>{{ title }}</h1>
        <a href="{{ url_for('main.inventory_stock_report_pdf', warehouse_id=selected_warehouse_id, show_zero_stock=show_zero_stock) }}" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors" target="_blank">
            <i class="fas fa-file-pdf mr-2"></i>Reporte Conteo Físico
        </a>
    </div>

    <!-- Filtros -->
    <div class="bg-white p-4 rounded-lg shadow-md mb-6">
        <form method="GET" action="{{ url_for('main.inventory_stock') }}">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Filtro por Almacén -->
                <div>
                    <label for="warehouse_id" class="block text-sm font-medium text-gray-700">Almacén</label>
                    <select name="warehouse_id" id="warehouse_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <option value="">Todos los Almacenes (Total)</option>
                        {% for warehouse in warehouses %}
                        <option value="{{ warehouse.id }}" {% if warehouse.id == selected_warehouse_id %}selected{% endif %}>
                            {{ warehouse.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Checkbox para mostrar sin existencia -->
                <div class="flex items-end">
                    <div class="flex items-center h-full">
                        <input id="show_zero_stock" name="show_zero_stock" type="checkbox" {% if show_zero_stock %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="show_zero_stock" class="ml-2 block text-sm text-gray-900">Mostrar productos sin existencia</label>
                    </div>
                </div>

                <!-- Botones -->
                <div class="flex items-end space-x-2">
                    <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors w-full text-center">
                        <i class="fas fa-filter mr-2"></i>Filtrar
                    </button>
                    <a href="{{ url_for('main.inventory_stock') }}" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors w-full text-center">
                        <i class="fas fa-eraser mr-2"></i>Limpiar
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Vista de Lista (Tabla) -->
    <div class="bg-white p-2 rounded-lg shadow-md">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto / Códigos</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Marca/Color/Talla</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Existencia</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Costo ({{ currency_symbol }})</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio ({{ currency_symbol }})</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor Total Stock ({{ currency_symbol }})</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for data in products_data %}
                    <tr>
                        <td class="px-3 py-2 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ data.product.name }}</div>
                            <div class="text-xs text-gray-500"><strong><i class="fas fa-barcode"></i></strong> {{ data.product.barcode }}</div>
                            <div class="text-xs text-gray-500"><strong>COD:</strong> {{ data.product.codigo_producto or 'N/A' }}</div>
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">
                            <div class="text-sm font-medium text-gray-900">{{ data.product.marca or '' }}</div>
                            <div class="text-xs text-gray-500"><strong></strong> {{ data.product.color or '' }}</div>
                            <div class="text-xs text-gray-500"><strong></strong> {{ data.product.size or '' }}</div>
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-center text-sm font-bold {% if data.stock <= 0 %}text-red-500{% elif data.stock < 10 %}text-yellow-500{% else %}text-green-500{% endif %}">
                            {{ data.stock }}
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-right text-sm text-gray-900 font-semibold">{{ "%.2f"|format(data.product.cost_usd) }}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-right text-sm text-gray-900 font-semibold">{{ "%.2f"|format(data.product.price_usd) }}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-right text-sm text-gray-900 font-bold">{{ "%.2f"|format(data.stock * data.product.price_usd) }}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-center text-sm font-medium">
                            <a href="{{ url_for('main.product_detail', product_id=data.product.id) }}" title="Ver Detalle" class="text-indigo-600 hover:text-indigo-900 mx-1"><i class="fas fa-eye"></i></a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="px-3 py-4 text-center text-gray-500">No se encontraron productos que coincidan con los filtros.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}

<script>
    // Script para que el cambio en el select y checkbox envíe el formulario automáticamente
    document.getElementById('warehouse_id').addEventListener('change', function() {
        this.form.submit();
    });
    document.getElementById('show_zero_stock').addEventListener('change', function() {
        this.form.submit();
    });
</script>
<script>
    $(function () {
        $("#stockTable").DataTable({
            "responsive": true, "lengthChange": false, "autoWidth": false,
            "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
        }).buttons().container().appendTo('#stockTable_wrapper .col-md-6:eq(0)');
    });
</script>
{% endblock %}