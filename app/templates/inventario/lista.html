{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-2 max-w-full">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-4">
        <div class="flex items-center flex-shrink-0">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mr-2"><i class="fas fa-boxes mr-2"></i>{{ title }}</h1>
            <!-- Botones de cambio de vista -->
            <div class="flex items-center">
                <button id="list-view-btn" class="p-2 rounded-lg bg-blue-500 text-white m-1" title="Vista de Lista">
                    <i class="fas fa-list"></i>
                </button>
                <button id="grid-view-btn" class="p-2 rounded-lg bg-gray-300 text-gray-700 m-1" title="Vista de Cuadrícula">
                    <i class="fas fa-th-large"></i>
                </button>
            </div>
        </div>

        <!-- Filtros y Búsqueda -->
        <div class="bg-white p-2 rounded-lg shadow-md w-full">
            <form method="GET" action="{{ url_for('main.inventory_list') }}">
                <div class="flex flex-wrap items-center gap-2">
                    <input type="text" name="search" id="search" value="{{ filters.search or '' }}" placeholder="Buscar por código, nombre, marca..." class="flex-grow min-w-0 w-1/3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    
                    <select name="group" id="group" onchange="this.form.submit()" class="min-w-0 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <option value="">Todos los Grupos</option>
                            {% for group in product_groups %}
                            <option value="{{ group }}" {% if filters.group == group %}selected{% endif %}>{{ group }}</option>
                            {% endfor %}
                    </select>

                    <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-blue-600 transition-colors" title="Filtrar"><i class="fas fa-filter"></i></button>
                    <a href="{{ url_for('main.inventory_list') }}" class="bg-gray-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-gray-600 transition-colors" title="Limpiar Filtros"><i class="fas fa-eraser"></i></a>
                    
                    <a href="{{ url_for('main.new_product') }}" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors ml-auto text-sm whitespace-nowrap">
                        <i class="fas fa-plus mr-2"></i>Nuevo Producto
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Vista de Lista (Tabla) -->
    <div id="list-view-container">
        <div class="bg-white p-2 rounded-lg shadow-md">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            {% set next_order_barcode = 'desc' if sort_by == 'barcode' and sort_order == 'asc' else 'asc' %}
                            {% set next_order_codigo = 'desc' if sort_by == 'codigo_producto' and sort_order == 'asc' else 'asc' %}
                            <th class="px-4 px-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Códigos
                                <a href="{{ url_for('main.inventory_list', search=filters.search, group=filters.group, sort_by='barcode', sort_order=next_order_barcode) }}" class="hover:text-blue-600 ml-2" title="Ordenar por Cód. Barra">
                                    <i class="fas fa-barcode"></i>
                                    {% if sort_by == 'barcode' %}
                                        <i class="fas fa-arrow-{{ 'up' if sort_order == 'asc' else 'down' }} ml-1"></i>
                                    {% endif %}
                                </a>
                                <a href="{{ url_for('main.inventory_list', search=filters.search, group=filters.group, sort_by='codigo_producto', sort_order=next_order_codigo) }}" class="hover:text-blue-600 ml-2" title="Ordenar por Cód. Producto">
                                    <i class="fas fa-tag"></i>
                                    {% if sort_by == 'codigo_producto' %}
                                        <i class="fas fa-arrow-{{ 'up' if sort_order == 'asc' else 'down' }} ml-1"></i>
                                    {% endif %}
                                </a>
                            </th>
                            {% set next_order_name = 'desc' if sort_by == 'name' and sort_order == 'asc' else 'asc' %}
                            <th class="px-4 px-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <a href="{{ url_for('main.inventory_list', search=filters.search, group=filters.group, sort_by='name', sort_order=next_order_name) }}" class="hover:text-blue-600">
                                    Nombre / Marca
                                    {% if sort_by == 'name' %}
                                        <i class="fas fa-arrow-{{ 'up' if sort_order == 'asc' else 'down' }} ml-1"></i>
                                    {% endif %}
                                </a>
                            </th>
                            
                            <th class="px-4 px-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grupo</th>
                            <th class="px-4 px-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Exist.</th>
                            <th class="px-4 px-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio ({{ currency_symbol }})</th>
                            <th class="px-4 px-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for product in products %}
                        <tr>
                             <td class="px-4 px-1 whitespace-nowrap">
                                <p class="text-xs text-gray-800"><i class="fas fa-barcode w-4 inline-block text-left"></i> {{ product.barcode }}</p>
                                <div class="text-xs text-gray-500"><strong>COD:</strong> {{ product.codigo_producto or 'N/A' }}</div>
                            </td>
                            <td class="px-4 px-1 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">{{ product.name }}</div>
                                <div class="text-sm text-gray-500">{{ product.marca or '' }}</div>
                            </td>
                           
                            <td class="px-4 px-1 whitespace-nowrap text-sm text-gray-500">{{ product.grupo or '' }}</td>
                            <td class="px-4 px-1 whitespace-nowrap text-center text-sm font-bold {% if product.stock <= 0 %}text-red-500{% elif product.stock < 10 %}text-yellow-500{% else %}text-green-500{% endif %}">
                                {{ product.stock }}
                            </td>
                            <td class="px-4 px-1 whitespace-nowrap text-right text-sm text-gray-900 font-semibold">{{ currency_symbol }}{{ "%.2f"|format(product.price_usd) }}</td>
                            <td class="px-4 px-1 whitespace-nowrap text-center text-sm font-medium">
                                <a href="{{ url_for('main.product_detail', product_id=product.id) }}" title="Ver Detalle" class="text-indigo-600 hover:text-indigo-900 mx-1"><i class="fas fa-eye"></i></a>
                                {% if user_role in ['Superusuario', 'Gerente'] %}
                                    <a href="{{ url_for('main.edit_product', product_id=product.id) }}" title="Editar Producto" class="text-yellow-600 hover:text-yellow-900 mx-1"><i class="fas fa-pencil-alt"></i></a>
                                    <a href="{{ url_for('main.edit_product_cost', product_id=product.id) }}" title="Editar Costos" class="text-blue-600 hover:text-blue-900 mx-1"><i class="fas fa-calculator"></i></a>
                                {% endif %}
                                {% if user_role in ['Superusuario', 'Gerente', 'Administrador'] %}
                                    <a href="{{ url_for('main.movement_list', product_id=product.id) }}" title="Ver Movimientos" class="text-green-600 hover:text-green-900 mx-1"><i class="fas fa-exchange-alt"></i></a>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="px-4 px-1 text-center text-gray-500">No se encontraron productos que coincidan con los filtros.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Vista de Cuadrícula (Grid) -->
    <div id="grid-view-container" class="hidden">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
            {% for product in products %}
            <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 flex flex-col group">
                <div class="relative">
                    <img src="{{ product.display_image_url }}" alt="{{ product.name }}" class="h-full h-48 object-cover">
                    <p class="text-xs text-gray-400 mb-3">Grupo: {{ product.grupo or '' }}</p>
                </div>
                
                <div class="p-4 flex-grow">
                    
                    <h6 class="text-md font-bold text-gray-800 truncate" title="{{ product.name }}">{{ product.name }}</h6>
                    <p class="text-sm text-gray-500 mb-2">{{ product.marca or '' }}</p>
                    <div class="flex justify-between items-center m-3">
                        <span class="text-sm font-semibold">Existencia:</span>
                        <span class="px-3 py-2 rounded-full text-xs font-bold {% if product.stock <= 0 %}bg-red-100 text-red-700{% elif product.stock < 10 %}bg-yellow-100 text-yellow-700{% else %}bg-green-100 text-green-700{% endif %}">
                            {{ product.stock }}
                        </span>
                    </div>
                    <p class="text-xs text-gray-800"><i class="fas fa-barcode w-4 inline-block text-left"></i> {{ product.barcode }}</p>

                    <div class="text-right">
                        <p class="text-xl font-bold text-gray-800">{{ currency_symbol }}{{ "%.2f"|format(product.price_usd) }}</p>
                    </div>
                </div>
                <div class="bg-gray-50 p-3 border-t flex justify-around items-center">
                    <a href="{{ url_for('main.product_detail', product_id=product.id) }}" title="Ver Detalle" class="text-indigo-600 hover:text-indigo-900 mx-1"><i class="fas fa-eye"></i></a>
                    {% if user_role in ['Superusuario', 'Gerente'] %}
                        <a href="{{ url_for('main.edit_product', product_id=product.id) }}" title="Editar Producto" class="text-yellow-600 hover:text-yellow-900 mx-1"><i class="fas fa-pencil-alt"></i></a>
                        <a href="{{ url_for('main.edit_product_cost', product_id=product.id) }}" title="Editar Costos" class="text-blue-600 hover:text-blue-900 mx-1"><i class="fas fa-calculator"></i></a>
                    {% endif %}
                    {% if user_role in ['Superusuario', 'Gerente', 'Administrador'] %}
                        <a href="{{ url_for('main.movement_list', product_id=product.id) }}" title="Ver Movimientos" class="text-green-600 hover:text-green-900 mx-1"><i class="fas fa-exchange-alt"></i></a>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="col-span-full text-center text-gray-500 py-20">
                No se encontraron productos que coincidan con los filtros.
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const listViewBtn = document.getElementById('list-view-btn');
    const gridViewBtn = document.getElementById('grid-view-btn');
    const listContainer = document.getElementById('list-view-container');
    const gridContainer = document.getElementById('grid-view-container');

    const activeBtnClasses = ['bg-blue-500', 'text-white'];
    const inactiveBtnClasses = ['bg-gray-300', 'text-gray-700'];

    function showListView() {
        listContainer.classList.remove('hidden');
        gridContainer.classList.add('hidden');
        
        listViewBtn.classList.add(...activeBtnClasses);
        listViewBtn.classList.remove(...inactiveBtnClasses);
        
        gridViewBtn.classList.add(...inactiveBtnClasses);
        gridViewBtn.classList.remove(...activeBtnClasses);

        localStorage.setItem('inventoryView', 'list');
    }

    function showGridView() {
        gridContainer.classList.remove('hidden');
        listContainer.classList.add('hidden');

        gridViewBtn.classList.add(...activeBtnClasses);
        gridViewBtn.classList.remove(...inactiveBtnClasses);

        listViewBtn.classList.add(...inactiveBtnClasses);
        listViewBtn.classList.remove(...activeBtnClasses);

        localStorage.setItem('inventoryView', 'grid');
    }

    listViewBtn.addEventListener('click', showListView);
    gridViewBtn.addEventListener('click', showGridView);

    // Cargar la vista preferida al cargar la página
    const preferredView = localStorage.getItem('inventoryView');
    if (preferredView === 'grid') {
        showGridView();
    } else {
        showListView(); // Por defecto, la vista de lista
    }
});
</script>
{% endblock %}